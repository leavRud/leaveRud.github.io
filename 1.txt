/* ===== CSS VARIABLES ===== */
:root {
  /* Цветовая палитра */
  --primary-color: #4361ee;
  --primary-dark: #3a56d4;
  --primary-light: #6d8bc5;
  --secondary-color: #7209b7;
  --secondary-light: #9d4edd;
  --accent-color: #f72585;
  --accent-light: #ff6b9d;
  
  /* Цвета состояния */
  --danger-color: #ff4757;
  --danger-light: #ff6b7a;
  --success-color: #2ed573;
  --success-light: #4de992;
  --warning-color: #ffa502;
  --warning-light: #ffbe40;
  --info-color: #4cc9f0;
  
  /* Тёмная тема (по умолчанию) */
  --bg-dark: #0f0f23;
  --bg-card: #1a1a2e;
  --bg-hover: #2d2d44;
  --bg-light: #2a2a3e;
  --border-color: #2a2a3e;
  --border-light: #3a3a4e;
  --text-primary: #ffffff;
  --text-secondary: #a0a0c0;
  --text-muted: #6c6c8a;
  --text-light: #d0d0e0;
  
  /* Стили */
  --radius-sm: 8px;
  --radius: 12px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.4);
  --shadow-inner: inset 0 2px 10px rgba(0, 0, 0, 0.2);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.15s ease;
}

/* ===== СВЕТЛАЯ ТЕМА ===== */
body.light-theme {
  --bg-dark: #f8fafc;
  --bg-card: #ffffff;
  --bg-hover: #f1f5f9;
  --bg-light: #f8fafc;
  --border-color: #e2e8f0;
  --border-light: #cbd5e1;
  --text-primary: #1e293b;
  --text-secondary: #475569;
  --text-muted: #64748b;
  --text-light: #334155;
  --shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.12);
  --shadow-inner: inset 0 2px 10px rgba(0, 0, 0, 0.05);
}

/* ===== СБРОС СТИЛЕЙ ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
  scroll-behavior: smooth;
}

::selection {
  background-color: rgba(67, 97, 238, 0.3);
  color: var(--text-primary);
}

::-webkit-scrollbar {
  width: 12px;
  height: 12px;
}

::-webkit-scrollbar-track {
  background: var(--bg-light);
  border-radius: var(--radius);
}

::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: var(--radius);
  border: 3px solid var(--bg-light);
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-light);
}

/* ===== ОСНОВНЫЕ СТИЛИ ===== */
body {
  background-color: var(--bg-dark);
  color: var(--text-primary);
  line-height: 1.6;
  height: 100vh;
  overflow: hidden;
  font-size: 15px;
}

:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
  border-radius: var(--radius-sm);
}

/* ===== КОНТЕЙНЕР ПРИЛОЖЕНИЯ ===== */
.app-container {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ===== БОКОВАЯ ПАНЕЛЬ ===== */
.sidebar {
  width: 390px;
  background-color: var(--bg-card);
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  transition: var(--transition);
  position: relative;
  z-index: 10;
}

.sidebar-header {
  padding: 28px;
  border-bottom: 1px solid var(--border-color);
  position: relative;
}

.sidebar-header h1 {
  font-size: 1.6rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 8px;
}

.sidebar-header h1 i {
  font-size: 1.4rem;
  color: var(--primary-color);
}

/* ===== СТАТИСТИКА ===== */
.stats {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-top: 16px;
}

.stats.has-stats {
  padding-bottom: 8px;
}

#totalCheatsheets {
  font-size: 2.2rem;
  font-weight: 800;
  color: var(--primary-color);
  line-height: 1;
}

.stats-label {
  font-size: 1rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.stats-breakdown {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}

#subjectStats {
  font-size: 0.85rem;
  color: var(--text-muted);
  line-height: 1.4;
}

/* ===== КНОПКИ ===== */
.btn {
  padding: 14px 22px;
  border: none;
  border-radius: var(--radius);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  outline: none;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  transform: translateX(-100%);
}

@keyframes shine {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.btn:hover::before {
  animation: shine 1.5s ease-out infinite;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn:active {
  transform: translateY(0);
}

.btn.processing {
  position: relative;
  overflow: hidden;
  pointer-events: none;
  opacity: 0.8;
}

.btn.processing::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

.btn-secondary.processing::after {
  border: 2px solid rgba(0, 0, 0, 0.1);
  border-top-color: var(--text-primary);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Варианты кнопок */
.btn-primary {
  background-color: var(--primary-color);
  color: white;
}

.btn-primary:hover {
  background-color: var(--primary-dark);
}

.btn-secondary {
  background-color: var(--bg-light);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.btn-secondary:hover {
  background-color: var(--bg-hover);
}

.btn-danger {
  background-color: var(--danger-color);
  color: white;
}

.btn-danger:hover {
  background-color: var(--danger-light);
}

.btn-success {
  background-color: var(--success-color);
  color: white;
}

.btn-text {
  background: none;
  border: none;
  color: var(--primary-color);
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  transition: var(--transition);
}

.btn-text:hover {
  background-color: rgba(67, 97, 238, 0.1);
  transform: translateY(-1px);
}

.btn-icon {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: none;
  background-color: var(--bg-light);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  font-size: 1rem;
}

.btn-icon:hover {
  background-color: var(--bg-hover);
  color: var(--text-primary);
  transform: rotate(5deg);
}

.btn-new {
  margin: 20px;
  padding: 16px;
  font-size: 1rem;
  box-shadow: var(--shadow);
}

/* ===== ФИЛЬТРЫ И ПОИСК ===== */
.filters {
  padding: 0 20px 20px;
  border-bottom: 1px solid var(--border-color);
}

.search-box {
  position: relative;
  margin-bottom: 20px;
}

.search-box i {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 1rem;
  z-index: 1;
}

.search-box input {
  width: 100%;
  padding: 14px 20px 14px 48px;
  background-color: var(--bg-light);
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 0.95rem;
  transition: var(--transition);
  position: relative;
}

.search-box input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}

.filter-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.filter-select {
  width: 100%;
  padding: 12px 16px;
  background-color: var(--bg-light);
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 0.9rem;
  cursor: pointer;
  transition: var(--transition);
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
}

.filter-select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}

/* ===== СПИСОК ШПАРГАЛОК ===== */
.cheatsheet-list {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.cheatsheet-list::-webkit-scrollbar {
  width: 8px;
}

.cheatsheet-list::-webkit-scrollbar-track {
  background: transparent;
}

.cheatsheet-list::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 4px;
}

.cheatsheet-list::-webkit-scrollbar-thumb:hover {
  background: var(--primary-light);
}

.cheatsheet-item {
  background-color: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  padding: 20px;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  margin-bottom: 12px;
}

.cheatsheet-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
  opacity: 0;
  transition: var(--transition);
}

.cheatsheet-item:hover {
  transform: translateX(8px);
  border-color: var(--primary-color);
  box-shadow: var(--shadow);
}

.cheatsheet-item:hover::before {
  opacity: 1;
}

.cheatsheet-item.active {
  border-color: var(--primary-color);
  background-color: rgba(67, 97, 238, 0.05);
  transform: translateX(8px);
}

.cheatsheet-item.active::before {
  opacity: 1;
}

.cheatsheet-item-header {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 12px;
}

.cheatsheet-subject-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.1rem;
  flex-shrink: 0;
}

.cheatsheet-info {
  flex: 1;
  min-width: 0;
}

.cheatsheet-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.95rem;
  margin-bottom: 6px;
  line-height: 1.3;
}

.cheatsheet-subject-task {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.cheatsheet-subject {
  font-size: 0.8rem;
  color: var(--primary-color);
  font-weight: 600;
  background-color: rgba(67, 97, 238, 0.1);
  padding: 3px 8px;
  border-radius: 12px;
  white-space: nowrap;
}

.cheatsheet-task {
  font-size: 0.8rem;
  color: var(--text-secondary);
  background-color: var(--bg-light);
  padding: 3px 8px;
  border-radius: 12px;
  white-space: nowrap;
}

.cheatsheet-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 6px;
}

.cheatsheet-tag {
  background-color: var(--bg-light);
  color: var(--text-secondary);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.75rem;
  white-space: nowrap;
}

.cheatsheet-meta {
  display: flex;
  justify-content: space-between;
  color: var(--text-muted);
  font-size: 0.75rem;
  padding-top: 10px;
  border-top: 1px solid var(--border-color);
}

.cheatsheet-tags-meta {
  color: var(--text-secondary);
  font-size: 0.8rem;
  max-width: 150px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ===== АНИМАЦИИ УДАЛЕНИЯ ===== */
@keyframes collapseDelete {
  0% {
    opacity: 1;
    transform: scale(1);
    max-height: 200px;
    margin-bottom: 12px;
  }
  50% {
    opacity: 0.5;
    transform: scale(0.95);
  }
  100% {
    opacity: 0;
    transform: scale(0);
    max-height: 0;
    margin-bottom: 0;
    padding: 0;
    border-width: 0;
  }
}

@keyframes blurDelete {
  0% { filter: blur(0px); opacity: 1; }
  100% { filter: blur(5px); opacity: 0; }
}

.cheatsheet-item.deleting,
.grid-item.deleting {
  animation: collapseDelete 0.5s ease-out forwards;
  pointer-events: none;
}

.cheatsheet-item.blur-delete,
.grid-item.blur-delete {
  animation: blurDelete 0.4s ease-out forwards;
}

.deleting-highlight {
  position: relative;
  overflow: hidden;
}

.deleting-highlight::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255, 71, 87, 0.1), transparent);
  animation: highlightShine 1.5s ease-out infinite;
}

@keyframes highlightShine {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ===== ОСНОВНОЙ КОНТЕНТ ===== */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background-color: var(--bg-dark);
}

.content-header {
  padding: 28px 32px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: var(--bg-card);
}

.content-header h2 {
  font-size: 1.8rem;
  font-weight: 700;
}

.content-area {
  flex: 1;
  padding: 32px;
  overflow-y: auto;
  background-color: var(--bg-dark);
}

.content-area::-webkit-scrollbar {
  width: 10px;
}

.content-area::-webkit-scrollbar-track {
  background: var(--bg-light);
  border-radius: var(--radius);
}

.content-area::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: var(--radius);
}

.content-area::-webkit-scrollbar-thumb:hover {
  background: var(--primary-light);
}

/* ===== СОСТОЯНИЯ ===== */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  text-align: center;
  padding: 60px 40px;
  max-width: 500px;
  margin: 0 auto;
}

.empty-icon {
  font-size: 5rem;
  color: var(--border-color);
  margin-bottom: 32px;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 1.8rem;
  margin-bottom: 16px;
  color: var(--text-primary);
  font-weight: 700;
}

.empty-state p {
  color: var(--text-secondary);
  margin-bottom: 32px;
  font-size: 1.1rem;
  line-height: 1.6;
}

/* ===== СЕТКА ШПАРГАЛОК ===== */
.cheatsheet-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 24px;
  animation: fadeIn 0.5s ease-out;
}

.grid-item {
  background-color: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 28px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  flex-direction: column;
  height: 200px;
  overflow: hidden;
  position: relative;
}

.grid-item:hover {
  transform: translateY(-8px);
  border-color: var(--primary-color);
  box-shadow: var(--shadow-lg);
}

.grid-item::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
  transform: scaleX(0);
  transform-origin: left;
  transition: var(--transition);
}

.grid-item:hover::after {
  transform: scaleX(1);
}

.grid-title {
  font-weight: 700;
  margin-bottom: 16px;
  color: var(--text-primary);
  font-size: 1.2rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  line-height: 1.4;
}

.grid-preview {
  color: var(--text-secondary);
  font-size: 0.95rem;
  line-height: 1.6;
  flex: 1;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  margin-bottom: 16px;
  white-space: normal;
  overflow-wrap: break-word;
}

body.light-theme .grid-preview {
  color: var(--text-secondary);
}

.grid-meta {
  display: flex;
  justify-content: space-between;
  color: var(--text-muted);
  font-size: 0.85rem;
  margin-top: auto;
}

/* ===== ПРОСМОТР ШПАРГАЛКИ ===== */
.cheatsheet-view {
  background-color: var(--bg-card);
  border-radius: var(--radius-lg);
  border: 2px solid var(--border-color);
  overflow: hidden;
  max-width: 900px;
  margin: 0 auto;
  animation: fadeIn 0.4s ease-out;
  box-shadow: var(--shadow);
}

.cheatsheet-view.updating .view-content {
  animation: contentUpdate 0.5s ease-out;
}

@keyframes contentUpdate {
  0% { opacity: 0.8; }
  50% { opacity: 1; background-color: rgba(67, 97, 238, 0.05); }
  100% { opacity: 1; }
}

.view-header {
  padding: 32px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  background-color: var(--bg-light);
}

.view-title h3 {
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 16px;
  color: var(--text-primary);
  line-height: 1.3;
}

.view-meta {
  display: flex;
  gap: 16px;
  align-items: center;
  flex-wrap: wrap;
}

.subject-badge,
.task-badge {
  padding: 10px 20px;
  border-radius: 50px;
  font-size: 0.9rem;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.subject-badge {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
  color: white;
  box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

.task-badge {
  background: linear-gradient(135deg, var(--secondary-color), var(--secondary-light));
  color: white;
  box-shadow: 0 4px 12px rgba(114, 9, 183, 0.3);
}

.date {
  color: var(--text-muted);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.view-actions {
  display: flex;
  gap: 12px;
}

.view-content {
  padding: 40px;
  line-height: 1.8;
  font-size: 1.05rem;
  color: var(--text-light);
  min-height: 300px;
  overflow-wrap: break-word;
}

/* ===== ФОРМАТИРОВАНИЕ ТЕКСТА В ПРОСМОТРЕ ===== */
.view-content strong,
.view-content b {
  color: var(--text-primary);
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.view-content em,
.view-content i {
  color: var(--accent-color);
  font-style: italic;
}

.view-content code {
  background-color: var(--bg-dark);
  color: var(--info-color);
  padding: 4px 8px;
  border-radius: var(--radius-sm);
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
  border: 1px solid var(--border-color);
}

.view-content pre {
  background-color: var(--bg-dark);
  color: var(--text-light);
  padding: 20px;
  border-radius: var(--radius);
  overflow-x: auto;
  margin: 20px 0;
  border: 1px solid var(--border-color);
  font-family: 'Courier New', monospace;
  line-height: 1.5;
}

.view-content pre code {
  background: none;
  border: none;
  padding: 0;
  color: inherit;
}

.view-content ul,
.view-content ol {
  margin-left: 24px;
  margin-bottom: 20px;
}

.view-content li {
  margin-bottom: 8px;
  position: relative;
}

.view-content ul li::before {
  content: '•';
  opacity: 0.8;
  font-weight: bold;
  display: inline-block;
  width: 1em;
  margin-left: -1em;
  position: absolute;
  left: 0;
}

body.light-theme .view-content ul li::before {
  color: var(--text-primary);
  opacity: 0.9;
}

body.dark-theme .view-content ul li::before {
  color: var(--text-light);
  opacity: 0.7;
}

.view-content h1 { font-size: 1.8rem; }
.view-content h2 { font-size: 1.6rem; }
.view-content h3 { font-size: 1.4rem; }
.view-content h4 { font-size: 1.2rem; }
.view-content h5 { font-size: 1.1rem; }
.view-content h6 { font-size: 1rem; }

.view-content h1,
.view-content h2,
.view-content h3,
.view-content h4,
.view-content h5,
.view-content h6 {
  color: var(--text-primary);
  margin: 24px 0 16px;
  font-weight: 700;
  line-height: 1.3;
}

.view-content blockquote {
  border-left: 4px solid var(--primary-color);
  margin: 24px 0;
  padding-left: 20px;
  color: var(--text-secondary);
  font-style: italic;
}

.view-content hr {
  border: none;
  height: 2px;
  background: linear-gradient(to right, transparent, var(--border-color), transparent);
  margin: 32px 0;
}

.view-content a {
  color: var(--primary-color);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: var(--transition);
}

.view-content a:hover {
  border-bottom-color: var(--primary-color);
}

.view-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  background-color: var(--bg-light);
  border-radius: var(--radius);
  overflow: hidden;
}

.view-content th,
.view-content td {
  padding: 12px 16px;
  border: 1px solid var(--border-color);
  text-align: left;
}

.view-content th {
  background-color: var(--bg-dark);
  color: var(--text-primary);
  font-weight: 600;
}

.view-content tr:nth-child(even) {
  background-color: rgba(255, 255, 255, 0.02);
}

/* ===== ФУТЕР БОКОВОЙ ПАНЕЛИ ===== */
.sidebar-footer {
  padding: 24px;
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: center;
  gap: 24px;
  background-color: var(--bg-card);
}

/* ===== МОДАЛЬНЫЕ ОКНА ===== */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  opacity: 0;
  animation: modalFadeIn 0.3s ease-out forwards;
  user-select: none;
}

.modal-content {
  background-color: var(--bg-card);
  border-radius: var(--radius-xl);
  width: 100%;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border-light);
  display: flex;
  flex-direction: column;
  user-select: text;
}

.modal-content *::selection {
  background-color: rgba(67, 97, 238, 0.3);
  color: inherit;
}

.modal-content.large {
  max-width: 1000px;
  max-height: 95vh;
}

.modal-content.medium {
  max-width: 700px;
}

.modal-header {
  padding: 32px 40px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  background-color: var(--bg-light);
  position: relative;
}

.modal-header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
}

.modal-header-content {
  flex: 1;
}

.modal-header h3 {
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.modal-subtitle {
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text-secondary);
  font-size: 1rem;
}

.modal-subtitle i {
  color: var(--primary-color);
}

.modal-body {
  padding: 40px;
  overflow-y: auto;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.modal-body.scrollable {
  overflow-y: auto;
  max-height: calc(90vh - 200px);
}

.modal-body::-webkit-scrollbar {
  width: 10px;
}

.modal-body::-webkit-scrollbar-track {
  background: var(--bg-light);
  border-radius: var(--radius);
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: var(--radius);
}

.modal-body::-webkit-scrollbar-thumb:hover {
  background: var(--primary-light);
}

/* ===== СТЕППЕР ФОРМЫ ===== */
.form-stepper {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 40px;
  position: relative;
  gap: 60px;
}

.stepper-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  position: relative;
  z-index: 2;
}

.step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--bg-light);
  color: var(--text-muted);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1rem;
  transition: var(--transition);
  border: 3px solid var(--border-color);
}

.step-label {
  font-size: 0.9rem;
  color: var(--text-muted);
  white-space: nowrap;
  font-weight: 500;
  transition: var(--transition);
}

.stepper-step.active .step-number {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
  box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

.stepper-step.active .step-label {
  color: var(--text-primary);
  font-weight: 600;
}

.stepper-step.completed .step-number {
  background-color: var(--success-color);
  color: white;
  border-color: var(--success-color);
}

.stepper-line {
  height: 3px;
  background: linear-gradient(to right, var(--border-color) 50%, var(--border-color) 50%);
  position: absolute;
  top: 20px;
  left: 80px;
  right: 80px;
}

.stepper-line.active {
  background: linear-gradient(to right, var(--primary-color) 50%, var(--border-color) 50%);
}

.stepper-line.completed {
  background: var(--primary-color);
}

/* ===== СЕТКА ПРЕДМЕТОВ ===== */
.subject-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-top: 16px;
}

.subject-btn {
  padding: 20px;
  background-color: var(--bg-light);
  border: 3px solid var(--border-color);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  position: relative;
  overflow: hidden;
}

.subject-btn:hover {
  border-color: var(--primary-light);
  transform: translateY(-4px);
  box-shadow: var(--shadow);
}

.subject-btn.active {
  border-color: var(--primary-color);
  background-color: rgba(67, 97, 238, 0.1);
  box-shadow: 0 8px 24px rgba(67, 97, 238, 0.2);
}

.subject-btn i {
  font-size: 1.8rem;
  color: var(--text-secondary);
  transition: var(--transition);
}

.subject-btn.active i {
  color: var(--primary-color);
  transform: scale(1.1);
}

/* ===== СЕТКА НОМЕРОВ ЗАДАНИЙ ===== */
.task-grid {
  display: grid;
  grid-template-columns: repeat(9, 1fr);
  gap: 10px;
  margin-top: 16px;
}

.task-btn {
  padding: 14px 8px;
  background-color: var(--bg-light);
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
  position: relative;
}

.task-btn:hover {
  border-color: var(--primary-light);
  transform: scale(1.05);
}

.task-btn.active {
  border-color: var(--primary-color);
  background-color: var(--primary-color);
  color: white;
  box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

/* ===== СТИЛИ ФОРМЫ ===== */
.form-section {
  animation: fadeIn 0.4s ease-out;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 32px;
  margin-bottom: 32px;
}

.form-group {
  margin-bottom: 32px;
  position: relative;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 14px;
  color: var(--text-primary);
  font-weight: 600;
  font-size: 1rem;
}

.form-label i {
  color: var(--primary-color);
  font-size: 1.1rem;
}

.required {
  color: var(--danger-color);
  margin-left: 4px;
  font-weight: 700;
}

.form-hint {
  margin-top: 8px;
  font-size: 0.85rem;
  color: var(--text-muted);
  line-height: 1.4;
}

.title-input,
.tags-input {
  padding: 16px 20px;
  background-color: var(--bg-light);
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 1rem;
  width: 100%;
  transition: var(--transition);
}

.title-input:focus,
.tags-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
}

/* ===== РЕДАКТОР ===== */
.editor-toolbar {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  padding: 16px;
  background-color: var(--bg-light);
  border-radius: var(--radius);
  border: 2px solid var(--border-color);
  flex-wrap: wrap;
}

.format-btn {
  width: 44px;
  height: 44px;
  border-radius: var(--radius-sm);
  border: 2px solid transparent;
  background-color: var(--bg-card);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  font-size: 1.1rem;
}

.format-btn:hover {
  background-color: var(--bg-hover);
  color: var(--text-primary);
  transform: translateY(-2px);
}

.format-btn.active {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

.content-editor {
  width: 100%;
  padding: 24px;
  background-color: var(--bg-light);
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 1.05rem;
  line-height: 1.8;
  font-family: 'Segoe UI', system-ui, sans-serif;
  resize: vertical;
  min-height: 350px;
  transition: var(--transition);
}

.content-editor:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
}

.editor-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border-color);
}

.char-info {
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text-muted);
  font-size: 0.9rem;
}

.char-info i {
  color: var(--text-secondary);
}

.char-info-separator {
  opacity: 0.4;
  font-weight: 300;
}

.content-tips {
  display: flex;
  gap: 12px;
}

/* ===== ТЕГИ ===== */
.tags-example {
  margin-top: 12px;
  font-size: 0.9rem;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.tag-example {
  background-color: var(--bg-light);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.tag-example:hover {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
  transform: scale(1.05);
}

/* ===== ПРЕДПРОСМОТР ===== */
.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-color);
}

.preview-header h4 {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.preview-card {
  background-color: var(--bg-light);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 32px;
  margin-bottom: 24px;
}

.preview-subject,
.preview-task {
  display: inline-block;
  padding: 8px 16px;
  border-radius: 50px;
  font-size: 0.9rem;
  font-weight: 700;
  margin-right: 12px;
  margin-bottom: 16px;
}

.preview-subject {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
  color: white;
}

.preview-task {
  background: linear-gradient(135deg, var(--secondary-color), var(--secondary-light));
  color: white;
}

.preview-title {
  margin: 16px 0 24px;
  font-size: 1.5rem;
  color: var(--text-primary);
  font-weight: 700;
  line-height: 1.4;
}

.preview-content {
  white-space: normal !important;
  line-height: 1.6;
  color: var(--text-light);
  padding: 24px;
  background-color: var(--bg-card);
  border-radius: var(--radius);
  margin: 20px 0;
  border: 1px solid var(--border-color);
  min-height: 200px;
  max-height: 400px;
  overflow-y: auto;
  font-family: inherit;
}

.preview-content::-webkit-scrollbar {
  width: 8px;
}

.preview-content::-webkit-scrollbar-track {
  background: transparent;
}

.preview-content::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 4px;
}

.preview-content .formatted-list {
  margin: 8px 0;
}

.preview-content h3 {
  color: var(--text-primary);
  font-size: 1.3rem;
  margin: 16px 0 8px;
  font-weight: 700;
}

.preview-content h4 {
  color: var(--text-primary);
  font-size: 1.1rem;
  margin: 12px 0 6px;
  font-weight: 600;
}

.preview-content strong {
  color: var(--text-primary);
  font-weight: 700;
}

.preview-content em {
  font-style: italic;
  color: var(--accent-color);
}

.preview-content code {
  background-color: var(--bg-dark);
  color: var(--info-color);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}

.preview-content pre {
  background-color: var(--bg-dark);
  padding: 12px;
  border-radius: var(--radius);
  overflow-x: auto;
  margin: 12px 0;
}

.preview-content hr {
  border: none;
  height: 1px;
  background-color: var(--border-color);
  margin: 16px 0;
}

.preview-tags {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border-color);
}

.preview-tag {
  background-color: var(--bg-card);
  color: var(--text-secondary);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.85rem;
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.preview-tag:hover {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
  transform: translateY(-2px);
}

/* ===== ПОДСКАЗКИ ===== */
.help-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-bottom: 32px;
}

.help-card {
  background-color: var(--bg-light);
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  padding: 24px;
  transition: var(--transition);
}

.help-card:hover {
  border-color: var(--primary-color);
  transform: translateY(-4px);
  box-shadow: var(--shadow);
}

.help-icon {
  width: 56px;
  height: 56px;
  border-radius: var(--radius);
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  font-size: 1.4rem;
}

.help-card h4 {
  margin-bottom: 12px;
  color: var(--text-primary);
  font-size: 1.1rem;
  font-weight: 700;
}

.help-card p {
  color: var(--text-secondary);
  font-size: 0.95rem;
  line-height: 1.5;
}

.help-example {
  margin-top: 32px;
  padding: 24px;
  background-color: var(--bg-light);
  border-radius: var(--radius);
  border: 2px solid var(--border-color);
}

.help-example h5 {
  margin-bottom: 16px;
  color: var(--text-primary);
  font-size: 1.1rem;
  font-weight: 700;
}

.help-example pre {
  background-color: var(--bg-card);
  color: var(--text-light);
  padding: 20px;
  border-radius: var(--radius);
  overflow-x: auto;
  font-family: 'Courier New', monospace;
  font-size: 0.95rem;
  line-height: 1.5;
  border: 1px solid var(--border-color);
  margin: 0;
}

/* ===== КНОПКИ ФОРМЫ ===== */
.form-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 40px;
  padding-top: 24px;
  border-top: 1px solid var(--border-color);
}

.form-actions-right {
  display: flex;
  gap: 16px;
}

/* ===== УВЕДОМЛЕНИЯ ===== */
.toast-container {
  position: fixed;
  bottom: 32px;
  right: 32px;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.toast {
  background-color: var(--bg-card);
  border-left: 5px solid var(--primary-color);
  border-radius: var(--radius);
  padding: 20px 24px;
  box-shadow: var(--shadow-lg);
  display: flex;
  justify-content: space-between;
  align-items: center;
  min-width: 320px;
  animation: toastSlideIn 0.4s ease-out;
  border: 1px solid var(--border-color);
}

.toast.success { border-left-color: var(--success-color); }
.toast.error { border-left-color: var(--danger-color); }
.toast.warning { border-left-color: var(--warning-color); }
.toast.info { border-left-color: var(--info-color); }

.toast-content {
  flex: 1;
  font-weight: 500;
  color: var(--text-primary);
}

.toast-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
  margin-left: 16px;
  font-size: 1.2rem;
  transition: var(--transition);
}

.toast-close:hover {
  color: var(--text-primary);
  transform: rotate(90deg);
}

/* ===== ОТФОРМАТИРОВАННЫЕ СПИСКИ ===== */
.formatted-list {
  list-style-type: none;
  margin: 12px 0;
  padding-left: 24px;
  position: relative;
}

.formatted-list li {
  margin-bottom: 8px;
  position: relative;
  padding-left: 0;
  line-height: 1.5;
}

.formatted-list li::before {
  content: '•';
  color: var(--primary-color);
  font-weight: bold;
  font-size: 1.2em;
  position: absolute;
  left: -20px;
  top: 0;
}

body.light-theme .formatted-list li::before {
  color: var(--primary-color);
  opacity: 0.9;
}

body.dark-theme .formatted-list li::before {
  color: var(--primary-light);
  opacity: 0.8;
}

/* ===== ЭКСПОРТ ===== */
.export-options {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-bottom: 32px;
}

.export-option {
  position: relative;
}

.export-option input[type="radio"] {
  display: none;
}

.export-option label {
  display: flex;
  align-items: flex-start;
  padding: 24px;
  background-color: var(--bg-light);
  border: 3px solid var(--border-color);
  border-radius: var(--radius);
  cursor: pointer;
  transition: var(--transition);
  position: relative;
}

.export-option label:hover {
  border-color: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.export-option input[type="radio"]:checked + label {
  border-color: var(--primary-color);
  background-color: rgba(67, 97, 238, 0.05);
}

.export-option input[type="radio"]:checked + label::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 5px;
  height: 100%;
  background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
}

.export-option-icon {
  width: 60px;
  height: 60px;
  border-radius: var(--radius);
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 20px;
  color: white;
  font-size: 1.5rem;
  flex-shrink: 0;
}

.export-option-content {
  flex: 1;
}

.export-option-content h4 {
  margin-bottom: 8px;
  color: var(--text-primary);
  font-size: 1.2rem;
  font-weight: 700;
}

.export-option-content p {
  color: var(--text-secondary);
  font-size: 0.95rem;
  line-height: 1.5;
  margin-bottom: 12px;
}

.export-count {
  display: inline-block;
  background-color: var(--primary-color);
  color: white;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 700;
}

.export-selection {
  display: none;
  margin-top: 24px;
  padding: 24px;
  background-color: var(--bg-light);
  border-radius: var(--radius);
  border: 2px solid var(--border-color);
  margin-bottom: 24px;
}

.export-selection.showing {
  display: block;
}

.export-checkboxes {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.export-checkbox-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  padding-top: 16px;
  border-bottom: 1px solid var(--border-color);
  flex-wrap: wrap;
}

.export-checkbox-actions .btn-text {
  padding: 8px 16px;
  background-color: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-weight: 600;
  transition: var(--transition);
  white-space: nowrap;
}

.export-checkbox-actions .btn-text:hover {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
  transform: translateY(-2px);
}

.export-checkbox-actions .btn-text i {
  margin-right: 6px;
}

.export-checkboxes-list {
  max-height: 300px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding-right: 5px;
}

.export-checkbox-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background-color: var(--bg-card);
  border-radius: var(--radius-sm);
  border: 2px solid var(--border-color);
  transition: var(--transition);
  cursor: pointer;
  position: relative;
}

.export-checkbox-item::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 0;
  cursor: pointer;
}

.export-checkbox-item:hover {
  border-color: var(--primary-light);
  background-color: var(--bg-hover);
  transform: translateX(4px);
  box-shadow: var(--shadow);
}

.export-checkbox-item.selected {
  border-color: var(--primary-color);
  background-color: rgba(67, 97, 238, 0.08);
}

.export-checkbox-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  margin-right: 12px;
  cursor: pointer;
  flex-shrink: 0;
  z-index: 1;
  position: relative;
}

.export-checkbox-content {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-width: 0;
  z-index: 1;
  position: relative;
}

.export-checkbox-main {
  flex: 1;
  min-width: 0;
  margin-right: 16px;
}

.export-checkbox-subject {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.9rem;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.export-checkbox-title {
  color: var(--text-secondary);
  font-size: 0.85rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.export-checkbox-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}

.export-checkbox-task {
  background-color: var(--primary-color);
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 700;
  white-space: nowrap;
}

.export-checkbox-date {
  color: var(--text-muted);
  font-size: 0.8rem;
  white-space: nowrap;
}

.export-no-items {
  text-align: center;
  color: var(--text-muted);
  padding: 40px 20px;
  font-style: italic;
  background-color: var(--bg-light);
  border-radius: var(--radius);
  border: 2px dashed var(--border-color);
}

/* ===== МОДАЛЬНОЕ ОКНО ПОДТВЕРЖДЕНИЯ ===== */
.confirm-modal {
  max-width: 500px;
  text-align: center;
  animation: confirmFadeIn 0.3s ease-out;
}

@keyframes confirmFadeIn {
  from { opacity: 0; transform: translateY(-20px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.confirm-icon {
  margin: 0 auto 24px;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 107, 122, 0.2));
  display: flex;
  align-items: center;
  justify-content: center;
  border: 3px solid var(--danger-color);
}

.confirm-icon i {
  font-size: 2.5rem;
  color: var(--danger-color);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.confirm-content {
  padding: 0 32px 32px;
}

.confirm-content h3 {
  font-size: 1.8rem;
  margin-bottom: 16px;
  color: var(--text-primary);
  font-weight: 700;
}

.confirm-content p {
  color: var(--text-secondary);
  font-size: 1.1rem;
  line-height: 1.5;
  margin-bottom: 24px;
}

.confirm-details {
  background-color: var(--bg-light);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 32px;
  border: 1px solid var(--border-color);
  text-align: left;
}

.confirm-details-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border-color);
}

.confirm-details-item:last-child {
  border-bottom: none;
}

.confirm-details-label {
  color: var(--text-muted);
  font-size: 0.95rem;
  font-weight: 500;
}

.confirm-details-value {
  color: var(--text-primary);
  font-weight: 600;
  font-size: 1rem;
}

.confirm-actions {
  display: flex;
  gap: 16px;
  justify-content: center;
}

.confirm-actions .btn {
  min-width: 160px;
  padding: 14px 24px;
  font-size: 1rem;
  font-weight: 600;
}

.confirm-actions .btn-secondary {
  background-color: var(--bg-light);
  border: 2px solid var(--border-color);
}

.confirm-actions .btn-secondary:hover {
  background-color: var(--bg-hover);
  border-color: var(--primary-light);
}

.confirm-actions .btn-danger {
  background: linear-gradient(135deg, var(--danger-color), #ff6b7a);
  box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
}

.confirm-actions .btn-danger:hover {
  background: linear-gradient(135deg, #ff6b7a, var(--danger-color));
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
}

/* ===== АНИМАЦИИ ===== */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
  from { transform: translateX(-20px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes modalFadeIn {
  from { opacity: 0; transform: translateY(-30px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes toastSlideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.fade-in { animation: fadeIn 0.5s ease-out; }
.slide-in { animation: slideIn 0.4s ease-out; }
.shake { animation: shake 0.6s ease-in-out; }

/* ===== УТИЛИТЫ ===== */
.hidden { display: none !important; }

.loading {
  position: relative;
  pointer-events: none;
  opacity: 0.7;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 24px;
  height: 24px;
  margin: -12px 0 0 -12px;
  border: 3px solid var(--border-color);
  border-top-color: var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

/* ===== АДАПТИВНОСТЬ ===== */

/* Большие экраны (1200px и меньше) */
@media (max-width: 1200px) {
  .modal-content.large {
    max-width: 95vw;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
    gap: 24px;
  }
  
  .task-grid {
    grid-template-columns: repeat(6, 1fr);
  }
}

/* Планшеты (992px и меньше) */
@media (max-width: 992px) {
  .app-container {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    height: auto;
    max-height: 60vh;
  }
  
  .cheatsheet-list {
    max-height: 40vh;
  }
  
  .subject-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .task-grid {
    grid-template-columns: repeat(5, 1fr);
  }
  
  .help-grid {
    grid-template-columns: 1fr;
  }
  
  .export-selection {
    max-height: 300px;
  }
  
  .export-checkbox-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .export-checkbox-meta {
    width: 100%;
    justify-content: space-between;
  }
}

/* Планшеты в портретной ориентации (768px и меньше) */
@media (max-width: 768px) {
      .app-container {
    flex-direction: column;
    min-height: 100vh;
  }
  
  .sidebar {
    width: 100%;
    height: auto;
  }
  
  .cheatsheet-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 10px;
  }
  
  .cheatsheet-item {
    margin-bottom: 0;
  }
  
  .sidebar.collapsed .cheatsheet-item {
    padding: 10px;
    text-align: center;
  }
  
  .sidebar.collapsed .cheatsheet-item .cheatsheet-info {
    display: none;
  }
  
  .sidebar-footer {
    padding: 15px;
    gap: 15px;
  }
  
  .btn-icon {
    width: 44px;
    height: 44px;
  }
  .modal-content {
    max-height: 100vh;
    border-radius: 0;
    margin: 0;
  }
  
  .modal-header,
  .modal-body {
    padding: 24px;
  }
  
  .content-header {
    padding: 20px 24px;
  }
  
  .content-area {
    padding: 24px;
  }
  
  .cheatsheet-grid {
    grid-template-columns: 1fr;
  }
  
  .subject-grid {
    grid-template-columns: 1fr;
  }
  
  .task-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .form-actions {
    flex-direction: column;
    gap: 16px;
  }
  
  .form-actions-right {
    flex-direction: column;
    width: 100%;
  }
  
  .btn {
    width: 100%;
  }
  
  .stepper-step .step-label {
    display: none;
  }
  
  .stepper-step {
    gap: 6px;
  }
  
  .confirm-modal {
    max-width: 90vw;
  }
  
  .confirm-actions {
    flex-direction: column;
  }
  
  .confirm-actions .btn {
    min-width: 100%;
    width: 100%;
  }
  
  .confirm-icon {
    width: 70px;
    height: 70px;
  }
  
  .confirm-icon i {
    font-size: 2rem;
  }
  
  .confirm-content h3 {
    font-size: 1.5rem;
  }
  
  .confirm-content p {
    font-size: 1rem;
  }
  
  .export-checkbox-actions {
    flex-direction: column;
    gap: 8px;
  }
  
  .export-checkbox-actions .btn-text {
    width: 100%;
    text-align: center;
  }
  
  .export-checkbox-item {
    flex-direction: column;
    align-items: flex-start;
    padding: 12px;
  }
  
  .export-checkbox-item input[type="checkbox"] {
    margin-bottom: 8px;
    align-self: flex-start;
  }
  
  .export-checkbox-content {
    width: 100%;
  }
  
  .export-checkbox-main {
    margin-right: 0;
    margin-bottom: 8px;
  }
  
  .modal-body.scrollable {
    max-height: calc(80vh - 150px);
  }
  
  .cheatsheet-tags-meta {
    max-width: 100px;
  }
  .cheatsheet-list {
    flex: 1;
    min-height: 200px; /* Минимальная высота */
    max-height: calc(100vh - 350px) !important; /* Адаптивная высота */
    overflow-y: auto;
    padding: 15px;
    height: auto;
  }
  
  /* Улучшаем пустое состояние */
  .empty-state {
    height: 100%;
    min-height: 300px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px 20px;
  }
  
  /* Фиксируем кнопки внизу */
  .mobile-menu {
    display: flex !important;
    position: sticky;
    bottom: 0;
    background: var(--bg-card);
    border-top: 1px solid var(--border-color);
    padding: 10px;
    z-index: 100;
  }
  
  .sidebar-footer {
    display: none !important;
  }
}

/* Мобильные устройства (480px и меньше) */
@media (max-width: 480px) {
  .sidebar-header {
    padding: 20px;
  }
  
  .sidebar-footer {
    padding: 20px;
    gap: 16px;
  }
  
  .task-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .toast-container {
    bottom: 20px;
    right: 20px;
    left: 20px;
  }
  
  .toast {
    min-width: auto;
    width: 100%;
  }
  
  .export-selection {
    padding: 16px;
    max-height: 300px;
  }
  
  .export-checkbox-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }
  
  .cheatsheet-tags-meta {
    max-width: 80px;
  }
}
/* ===== АДАПТИВНОСТЬ ДЛЯ ТЕЛЕФОНОВ ===== */

/* Телефоны в альбомной ориентации (640px и меньше) */
@media (max-width: 640px) {
  .app-container {
    flex-direction: column;
    height: auto;
    min-height: 100vh;
  }
  
  .sidebar {
    width: 100%;
    height: auto;
    max-height: 70vh;
    border-right: none;
    border-bottom: 1px solid var(--border-color);
  }
  
  .sidebar-header {
    padding: 20px;
  }
  
  .sidebar-header h1 {
    font-size: 1.3rem;
  }
  
  .btn-new {
    margin: 15px;
    padding: 14px;
    font-size: 0.9rem;
  }
  
  .filters {
    padding: 0 15px 15px;
  }
  
  .filter-row {
    grid-template-columns: 1fr;
  }
  
  .cheatsheet-list {
    padding: 15px;
    max-height: 50vh;
  }
  
  .cheatsheet-item {
    padding: 15px;
    margin-bottom: 8px;
  }
  
  .content-header {
    padding: 20px 15px;
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .content-header h2 {
    font-size: 1.4rem;
  }
  
  .content-area {
    padding: 20px 15px;
  }
  
  .cheatsheet-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .grid-item {
    padding: 20px;
    height: auto;
    min-height: 180px;
  }
  
  .view-header {
    padding: 20px;
    flex-direction: column;
    gap: 15px;
  }
  
  .view-title h3 {
    font-size: 1.5rem;
  }
  
  .view-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .view-actions {
    width: 100%;
    justify-content: center;
  }
  
  .view-content {
    padding: 20px;
  }
  
  .modal-content {
    max-width: 95vw;
    max-height: 95vh;
    margin: 10px;
  }
  
  .modal-header,
  .modal-body {
    padding: 20px;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .subject-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  
  .task-grid {
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
  }
  
  .subject-btn,
  .task-btn {
    padding: 15px 10px;
    font-size: 0.9rem;
  }
  
  .subject-btn i {
    font-size: 1.4rem;
  }
  
  .editor-toolbar {
    justify-content: center;
  }
  
  .content-editor {
    min-height: 300px;
  }
  
  .editor-footer {
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }
  
  .form-actions {
    flex-direction: column;
    gap: 15px;
  }
  
  .form-actions-right {
    width: 100%;
    flex-direction: column;
    gap: 10px;
  }
  
  .btn {
    width: 100%;
  }
  
  .preview-card {
    padding: 20px;
  }
  
  .export-options {
    gap: 12px;
  }
  
  .export-option label {
    padding: 20px;
    text-align: center;
    gap: 15px;
  }
  
  .export-option-icon {
    margin-right: 0;
  }
  
  .export-checkbox-item {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .export-checkbox-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
    width: 100%;
  }
  
  .export-checkbox-meta {
    width: 100%;
    justify-content: space-between;
  }
}

/* Маленькие телефоны (480px и меньше) */
@media (max-width: 480px) {
  .sidebar-header h1 {
    font-size: 1.2rem;
    flex-wrap: wrap;
  }
  
  .stats {
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
  }
  
  #totalCheatsheets {
    font-size: 1.8rem;
  }
  
  .subject-grid {
    grid-template-columns: 1fr;
  }
  
  .task-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .subject-btn {
    padding: 15px;
    flex-direction: row;
    justify-content: flex-start;
    text-align: left;
    gap: 15px;
  }
  
  .subject-btn i {
    font-size: 1.2rem;
  }
  
  .task-btn {
    padding: 12px 6px;
    font-size: 0.85rem;
  }
  
  .cheatsheet-item {
    padding: 12px;
  }
  
  .cheatsheet-subject-icon {
    width: 32px;
    height: 32px;
    font-size: 0.9rem;
  }
  
  .cheatsheet-title {
    font-size: 0.9rem;
  }
  
  .content-header {
    padding: 15px;
  }
  
  .content-header h2 {
    font-size: 1.2rem;
  }
  
  .view-title h3 {
    font-size: 1.3rem;
  }
  
  .subject-badge,
  .task-badge {
    padding: 8px 15px;
    font-size: 0.8rem;
  }
  
  .modal-content {
    max-width: 100vw;
    max-height: 100vh;
    margin: 0;
    border-radius: 0;
  }
  
  .modal-header {
    padding: 15px;
  }
  
  .modal-header h3 {
    font-size: 1.4rem;
  }
  
  .modal-body {
    padding: 15px;
  }
  
  .form-stepper {
    gap: 30px;
  }
  
  .stepper-line {
    left: 50px;
    right: 50px;
  }
  
  .step-label {
    display: none;
  }
  
  .preview-title {
    font-size: 1.2rem;
  }
  
  .preview-content {
    padding: 15px;
    max-height: 300px;
  }
  
  .toast-container {
    bottom: 10px;
    right: 10px;
    left: 10px;
  }
  
  .toast {
    min-width: auto;
    width: 100%;
  }
  
  .confirm-actions {
    flex-direction: column;
    gap: 10px;
  }
  
  .confirm-actions .btn {
    min-width: 100%;
  }
}

/* Очень маленькие телефоны (360px и меньше) */
@media (max-width: 360px) {
  :root {
    --radius-sm: 6px;
    --radius: 8px;
    --radius-lg: 10px;
    --radius-xl: 12px;
  }
  
  .sidebar-header {
    padding: 15px;
  }
  
  .sidebar-header h1 {
    font-size: 1.1rem;
    gap: 10px;
  }
  
  .sidebar-header h1 i {
    font-size: 1rem;
  }
  
  .btn-new {
    margin: 12px;
    padding: 12px;
    font-size: 0.85rem;
  }
  
  .search-box input {
    padding: 12px 15px 12px 40px;
    font-size: 0.9rem;
  }
  
  .filter-select {
    padding: 10px 12px;
    font-size: 0.85rem;
  }
  
  .cheatsheet-item {
    padding: 10px;
  }
  
  .cheatsheet-subject,
  .cheatsheet-task {
    font-size: 0.75rem;
    padding: 2px 6px;
  }
  
  .grid-item {
    padding: 15px;
  }
  
  .grid-title {
    font-size: 1rem;
  }
  
  .grid-preview {
    font-size: 0.9rem;
  }
  
  .view-content {
    padding: 15px;
    font-size: 0.95rem;
  }
  
  .task-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .content-editor {
    padding: 15px;
    font-size: 1rem;
  }
  
  .format-btn {
    width: 40px;
    height: 40px;
  }
  
  .help-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
}

/* Поддержка высоты экрана (для мобильных браузеров) */
@media (max-height: 700px) {
  .modal-content {
    max-height: 85vh;
  }
  
  .modal-body {
    max-height: 60vh;
    overflow-y: auto;
  }
  
  .content-editor {
    min-height: 250px;
  }
  
  .preview-content {
    max-height: 250px;
  }
}

/* Пейзажная ориентация на телефонах */
@media (max-width: 768px) and (orientation: landscape) {
  .sidebar {
    max-height: 50vh;
  }
  
  .cheatsheet-list {
    max-height: 40vh;
  }
  
  .content-area {
    max-height: 50vh;
  }
  
  .modal-content {
    max-height: 85vh;
  }
}

/* Улучшение для касаний на мобильных */
@media (hover: none) and (pointer: coarse) {
  .btn,
  .btn-icon,
  .btn-text,
  .subject-btn,
  .task-btn,
  .cheatsheet-item,
  .grid-item,
  .format-btn,
  .export-checkbox-item {
    min-height: 44px; /* Минимальный размер для удобного касания */
  }
  
  .btn-icon {
    width: 44px;
    height: 44px;
  }
  
  input,
  select,
  textarea {
    font-size: 16px !important; /* Предотвращает зум в iOS */
  }
  
  .search-box input,
  .filter-select {
    min-height: 44px;
  }
}

/* Плавные анимации для мобильных */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Темная тема для мобильных с OLED экранами */
@media (max-width: 480px) and (prefers-color-scheme: dark) {
  body:not(.light-theme) {
    --bg-dark: #000000;
    --bg-card: #111111;
    --bg-hover: #222222;
  }
}
/* Улучшения для мобильного UX */

/* Предотвращение выделения текста при касании */
.cheatsheet-item,
.grid-item,
.btn,
.btn-icon {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  user-select: none;
}

/* Улучшение скролла на iOS */
.modal-body,
.content-area,
.cheatsheet-list {
  -webkit-overflow-scrolling: touch;
}

/* Фикс для фиксированных элементов в мобильных браузерах */
.modal,
.toast-container {
  position: fixed;
}

/* Улучшение для инпутов на iOS */
input[type="text"],
input[type="search"],
textarea,
select {
  appearance: none;
  -webkit-appearance: none;
  border-radius: var(--radius);
}

/* Увеличение кликабельной области для маленьких элементов */
.cheatsheet-subject-icon,
.task-number-badge {
  position: relative;
}

.cheatsheet-subject-icon::after,
.task-number-badge::after {
  content: '';
  position: absolute;
  top: -10px;
  left: -10px;
  right: -10px;
  bottom: -10px;
}

/* Адаптивные изображения */
img {
  max-width: 100%;
  height: auto;
}

/* Скрытие лишних элементов на мобильных */
@media (max-width: 640px) {
  .stats-breakdown,
  .modal-subtitle,
  .form-hint,
  .tags-example,
  .char-info-separator {
    display: none;
  }
  
  .char-info {
    font-size: 0.8rem;
  }
}
/* ===== МОБИЛЬНАЯ АДАПТИВНОСТЬ ===== */

/* Телефоны (до 768px) - переключаемся на модальный режим */
@media (max-width: 768px) {
  .app-container {
    flex-direction: column;
    height: auto;
    min-height: 100vh;
  }
  
  .sidebar {
    width: 100%;
    height: auto;
    border-right: none;
    border-bottom: 1px solid var(--border-color);
  }
  
  /* Скрываем основной контент на мобильных */
  .main-content {
    display: none !important;
  }
  
  /* Когда показываем просмотр в модальном окне */
  .main-content.mobile-active {
    display: flex !important;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    background: var(--bg-dark);
    animation: modalFadeIn 0.3s ease-out;
  }
  
  .main-content.mobile-active .content-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--bg-card);
  }
  
  .main-content.mobile-active .content-area {
    padding: 20px;
    overflow-y: auto;
  }
  
  /* Адаптируем просмотр для мобильных */
  .cheatsheet-view {
    max-width: 100%;
    border: none;
    border-radius: 0;
    background: transparent;
    box-shadow: none;
  }
  
  .view-header {
    padding: 20px;
    flex-direction: column;
    gap: 15px;
  }
  
  .view-title h3 {
    font-size: 1.5rem;
  }
  
  .view-meta {
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .subject-badge,
  .task-badge {
    padding: 8px 15px;
    font-size: 0.85rem;
  }
  
  .view-content {
    padding: 20px;
    font-size: 1rem;
  }
  
  /* Адаптируем список для мобильных */
  .cheatsheet-list {
    max-height: 60vh;
  }
  
  .cheatsheet-item {
    margin-bottom: 8px;
  }
  
  /* Кнопка "Назад" в модальном режиме */
  #closeViewBtn.mobile-back-btn {
    display: flex !important;
    background: var(--primary-color);
    color: white;
    width: 44px;
    height: 44px;
  }
  
  #closeViewBtn.mobile-back-btn:hover {
    background: var(--primary-dark);
  }
}

/* Телефоны в портретной ориентации (до 480px) */
@media (max-width: 480px) {
  .sidebar-header {
    padding: 20px;
  }
  
  .sidebar-header h1 {
    font-size: 1.3rem;
  }
  
  .btn-new {
    margin: 15px;
    padding: 14px;
  }
  
  .filters {
    padding: 0 15px 15px;
  }
  
  .cheatsheet-list {
    padding: 15px;
  }
  
  .cheatsheet-item {
    padding: 15px;
  }
  
  .cheatsheet-title {
    font-size: 0.9rem;
  }
  
  .view-title h3 {
    font-size: 1.3rem;
  }
  
  .view-content {
    padding: 15px;
    font-size: 0.95rem;
  }
}

/* Очень маленькие телефоны (до 360px) */
@media (max-width: 360px) {
  .sidebar-header h1 {
    font-size: 1.1rem;
  }
  
  .btn-new {
    margin: 12px;
    padding: 12px;
    font-size: 0.9rem;
  }
  
  .cheatsheet-item {
    padding: 12px;
  }
  
  .cheatsheet-subject-icon {
    width: 36px;
    height: 36px;
  }
}

/* Пейзажная ориентация на телефонах */
@media (max-width: 768px) and (orientation: landscape) {
  .sidebar {
    max-height: 50vh;
  }
  
  .cheatsheet-list {
    max-height: 35vh;
  }
  
  .main-content.mobile-active .content-area {
    max-height: calc(100vh - 80px);
  }
}

/* Улучшение для касаний */
@media (hover: none) and (pointer: coarse) {
  .btn,
  .cheatsheet-item,
  .btn-icon {
    min-height: 44px;
  }
  
  input,
  select,
  textarea {
    font-size: 16px !important;
  }
}
/* ===== МОБИЛЬНОЕ МОДАЛЬНОЕ ОКНО ===== */

/* Фон для модального окна на мобильных */
.main-content.mobile-active::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: -1;
}

/* Анимация появления */
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.main-content.mobile-active .cheatsheet-view {
    animation: slideUp 0.3s ease-out;
}

/* Кнопка закрытия */
#closeViewBtn.mobile-back-btn {
    position: relative;
    background: var(--primary-color);
    color: white;
    transition: var(--transition);
}

#closeViewBtn.mobile-back-btn:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
}

/* Затемнение при открытом модальном окне */
body.mobile-modal-open {
    overflow: hidden;
}

body.mobile-modal-open .sidebar {
    filter: blur(2px);
    opacity: 0.7;
    pointer-events: none;
}

/* Улучшение скролла на iOS */
.main-content.mobile-active .content-area {
    -webkit-overflow-scrolling: touch;
}

/* Адаптивные заголовки */
@media (max-width: 768px) {
    .main-content.mobile-active .content-header {
        padding: 15px 20px;
        background: var(--bg-card);
        box-shadow: var(--shadow);
    }
    
    .main-content.mobile-active .content-header h2 {
        font-size: 1.2rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
}
/* ===== ПЛАНШЕТНАЯ АДАПТИВНОСТЬ (768-990px) ===== */
@media (min-width: 768px) and (max-width: 990px) {
  .app-container {
    flex-direction: column;
    height: auto;
    min-height: 100vh;
  }
  
  .sidebar {
    width: 100%;
    height: auto;
    max-height: 50vh;
    border-right: none;
    border-bottom: 1px solid var(--border-color);
    order: 2; /* Перемещаем sidebar вниз */
  }
  
  .main-content {
    order: 1; /* Перемещаем main-content наверх */
    width: 100%;
    height: 50vh;
    min-height: 50vh;
    border-bottom: 1px solid var(--border-color);
  }
  
  /* Убираем лишние отступы */
  .sidebar-header,
  .filters {
    padding: 20px;
  }
  
  .btn-new {
    margin: 20px;
  }
  
  .cheatsheet-list {
    max-height: 30vh;
    overflow-y: auto;
  }
  
  .content-header {
    padding: 20px;
  }
  
  .content-area {
    padding: 20px;
    height: calc(50vh - 80px); /* Высота минус заголовок */
    overflow-y: auto;
  }
  
  /* Адаптируем сетку */
  .cheatsheet-grid {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
  }
  
  .grid-item {
    height: 180px;
    padding: 20px;
  }
  
  /* Адаптируем просмотр */
  .cheatsheet-view {
    max-width: 100%;
    margin: 0;
  }
  
  .view-header {
    padding: 20px;
  }
  
  .view-content {
    padding: 20px;
    max-height: calc(50vh - 160px);
    overflow-y: auto;
  }
}

/* Улучшение для планшетов в альбомной ориентации */
@media (min-width: 768px) and (max-width: 990px) and (orientation: landscape) {
  .sidebar {
    max-height: 40vh;
  }
  
  .main-content {
    height: 60vh;
    min-height: 60vh;
  }
  
  .cheatsheet-list {
    max-height: 25vh;
  }
  
  .content-area {
    height: calc(60vh - 80px);
  }
  
  .grid-item {
    height: 160px;
  }
}
/* ===== МОБИЛЬНАЯ АДАПТИВНОСТЬ (до 768px) ===== */
@media (max-width: 768px) {
  .app-container {
    flex-direction: column;
    height: 100vh; /* Фиксируем высоту */
  }
  
  .sidebar {
    width: 100%;
    height: 100vh; /* Занимаем всю высоту */
    border-right: none;
    display: flex;
    flex-direction: column;
  }
  
  /* Растягиваем список на всё доступное пространство */
  .cheatsheet-list {
    flex: 1; /* Занимает всё оставшееся пространство */
    min-height: 0; /* Важно для правильной работы flex в старых браузерах */
    max-height: none !important; /* Снимаем ограничения */
    overflow-y: auto;
    padding: 15px;
  }
  
  /* Уменьшаем отступы в заголовке */
  .sidebar-header {
    padding: 20px 20px 15px;
    flex-shrink: 0; /* Запрещаем сжатие */
  }
  
  .sidebar-header h1 {
    font-size: 1.3rem;
  }
  
  /* Фиксируем кнопку добавления */
  .btn-new {
    margin: 0 20px 15px;
    flex-shrink: 0;
  }
  
  /* Фиксируем фильтры */
  .filters {
    padding: 0 20px 15px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border-color);
  }
  
  /* Увеличиваем элементы списка для удобного касания */
  .cheatsheet-item {
    margin-bottom: 10px;
    padding: 18px;
  }
  
  /* Улучшаем визуализацию пустого состояния */
  .empty-state {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 40px 20px;
  }
  
  .empty-icon {
    font-size: 4rem;
  }
  
  .empty-state h3 {
    font-size: 1.5rem;
  }
  
  /* Убираем main-content */
  .main-content {
    display: none !important;
  }
  
  /* Стили для мобильного просмотра (модальное окно) */
  .main-content.mobile-active {
    display: flex !important;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    background: var(--bg-dark);
  }
  
  .main-content.mobile-active .content-area {
    padding: 0;
    height: 100%;
  }
  
  /* Улучшаем скролл на iOS */
  .cheatsheet-list,
  .main-content.mobile-active .content-area {
    -webkit-overflow-scrolling: touch;
  }
}

/* Телефоны в портретной ориентации */
@media (max-width: 480px) {
  .sidebar-header {
    padding: 15px 15px 10px;
  }
  
  .sidebar-header h1 {
    font-size: 1.2rem;
  }
  
  .btn-new {
    margin: 0 15px 10px;
    padding: 14px;
    font-size: 0.95rem;
  }
  
  .filters {
    padding: 0 15px 10px;
  }
  
  .filter-row {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .cheatsheet-list {
    padding: 10px;
  }
  
  .cheatsheet-item {
    padding: 15px;
    margin-bottom: 8px;
  }
  
  .empty-icon {
    font-size: 3.5rem;
  }
  
  .empty-state h3 {
    font-size: 1.3rem;
  }
}

/* Пейзажная ориентация на телефонах */
@media (max-width: 768px) and (orientation: landscape) {
  .sidebar-header {
    padding: 15px;
  }
  
  .btn-new {
    margin: 0 15px 10px;
    padding: 12px;
  }
  
  .filters {
    padding: 0 15px 10px;
  }
  
  .filter-row {
    grid-template-columns: 1fr 1fr;
  }
  
  /* В пейзажной ориентации можно показать больше контента */
  .cheatsheet-item {
    display: flex;
    align-items: center;
    min-height: 60px;
    padding: 12px;
  }
  
  .cheatsheet-item-header {
    margin-bottom: 0;
    flex: 1;
  }
  
  .cheatsheet-meta {
    display: none; /* Скрываем мета-данные для экономии места */
  }
}
/* ===== УТИЛИТЫ ДЛЯ МОБИЛЬНЫХ ===== */

/* Предотвращение зума при фокусе на iOS */
@media (max-width: 768px) {
  input[type="text"],
  input[type="search"],
  textarea,
  select {
    font-size: 16px !important;
  }
}

/* Улучшение для касаний */
@media (hover: none) and (pointer: coarse) {
  .cheatsheet-item,
  .btn,
  .btn-icon {
    min-height: 44px;
    cursor: pointer;
  }
  
  .cheatsheet-item:active {
    background-color: var(--bg-hover);
    transform: scale(0.98);
  }
}

/* Скрываем лишние элементы на мобильных */
@media (max-width: 768px) {
  .sidebar-footer {
    display: none; /* Футер можно скрыть или вынести в другое место */
  }
  
  /* Альтернатива: выносим кнопки в выпадающее меню */
  .mobile-menu {
    display: flex;
    justify-content: space-around;
    padding: 10px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-card);
  }
}
/* ===== ПЛАНШЕТНАЯ АДАПТИВНОСТЬ (768-990px) ===== */
@media (min-width: 768px) and (max-width: 990px) {
  .app-container {
    flex-direction: column;
    height: 100vh;
  }
  
  .sidebar {
    width: 100%;
    height: auto;
    min-height: auto;
    max-height: none;
    border-right: none;
    border-bottom: 1px solid var(--border-color);
    order: 1; /* Sidebar идет первым */
  }
  
  .main-content {
    order: 2; /* Main content идет вторым */
    width: 100%;
    flex: 1;
    height: auto;
    min-height: 0;
  }
  
  /* Sidebar-header должен быть видим и на своем месте */
  .sidebar-header {
    padding: 20px;
    display: block !important;
  }
  
  .btn-new {
    margin: 20px;
  }
  
  .filters {
    padding: 0 20px 20px;
  }
  
  .cheatsheet-list {
    max-height: 40vh;
    min-height: 200px;
    overflow-y: auto;
  }
  
  .content-header {
    padding: 20px;
  }
  
  .content-area {
    padding: 20px;
    height: calc(60vh - 80px); /* Оставляем место для header */
    min-height: 300px;
    overflow-y: auto;
  }
  
  /* Адаптируем сетку */
  .cheatsheet-grid {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
  }
  
  .grid-item {
    height: 180px;
    padding: 20px;
  }
  
  /* Адаптируем просмотр */
  .cheatsheet-view {
    max-width: 100%;
    margin: 0;
  }
  
  .view-header {
    padding: 20px;
  }
  
  .view-content {
    padding: 20px;
    max-height: calc(60vh - 160px);
    overflow-y: auto;
  }
  
  /* Показываем footer на планшетах */
  .sidebar-footer {
    display: flex !important;
    padding: 20px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-card);
  }
  
  .mobile-menu {
    display: none !important; /* Скрываем мобильное меню на планшетах */
  }
}

/* Улучшение для планшетов в альбомной ориентации */
@media (min-width: 768px) and (max-width: 990px) and (orientation: landscape) {
  .sidebar {
    max-height: 45vh;
  }
  
  .cheatsheet-list {
    max-height: 30vh;
  }
  
  .content-area {
    height: calc(55vh - 80px);
  }
  
  .grid-item {
    height: 160px;
  }
}
/* ===== МОБИЛЬНАЯ АДАПТИВНОСТЬ (до 768px) ===== */
@media (max-width: 768px) {
  .app-container {
    flex-direction: column;
    height: 100vh;
  }
  
  .sidebar {
    width: 100%;
    height: 100vh;
    border-right: none;
    display: flex;
    flex-direction: column;
  }
  
  /* Исправляем кнопку "Новая шпаргалка" - делаем адаптивной */
  .btn-new {
    margin: 15px;
    padding: 14px 16px;
    font-size: 0.95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0; /* Разрешаем сжатие */
    width: calc(100% - 30px); /* Учитываем отступы */
    box-sizing: border-box;
  }
  
  /* Фиксируем кнопки в футере для телефонов */
  .sidebar-footer {
    display: none; /* Скрываем десктопный футер */
  }
  
  .mobile-menu {
    display: flex !important;
    justify-content: space-around;
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-card);
    position: sticky;
    bottom: 0;
    z-index: 100;
  }
  
  .mobile-menu .btn-icon {
    width: 50px;
    height: 50px;
    font-size: 1.2rem;
    background-color: var(--bg-light);
    border: 2px solid var(--border-color);
  }
  
  /* Улучшаем список для мобильных */
  .cheatsheet-list {
    flex: 1;
    min-height: 0;
    padding: 15px;
  }
  
  .cheatsheet-item {
    margin-bottom: 10px;
    padding: 16px;
  }
  
  /* Адаптируем заголовок на мобильных */
  .sidebar-header h1 {
    font-size: 1.3rem;
    white-space: normal;
    line-height: 1.3;
  }
  
  /* Убираем main-content из потока */
  .main-content {
    display: none !important;
  }
  
  /* Стили для мобильного просмотра (модальное окно) */
  .main-content.mobile-active {
    display: flex !important;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    background: var(--bg-dark);
  }
  
  .main-content.mobile-active .content-area {
    padding: 0;
    height: 100%;
  }
    .cheatsheet-list {
    flex: 1;
    min-height: 0;
    max-height: none !important;
    overflow-y: auto;
    padding: 15px;
    /* Добавляем автоматическое растяжение */
    height: auto;
    max-height: calc(100vh - 400px); /* Адаптивная высота */
  }
  
  /* Улучшаем пустое состояние */
  .empty-state {
    height: 100%;
    min-height: 300px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px 20px;
  }
  .sidebar-footer {
    display: flex !important; /* Принудительно показываем */
    padding: 10px;
    gap: 10px;
  }
  
  .mobile-menu {
    display: flex !important; /* Принудительно показываем */
    justify-content: space-around;
    padding: 10px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-card);
    position: sticky;
    bottom: 0;
    z-index: 100;
  }
  
  .mobile-menu .btn-icon {
    width: 44px;
    height: 44px;
    font-size: 1.1rem;
    background-color: var(--bg-light);
    border: 2px solid var(--border-color);
  }
}

/* Очень маленькие телефоны - дополнительная адаптация */
@media (max-width: 480px) {
  .btn-new {
    margin: 12px;
    padding: 12px 14px;
    font-size: 0.9rem;
    width: calc(100% - 24px);
  }
  
  .sidebar-header h1 {
    font-size: 1.1rem;
  }
  
  .mobile-menu .btn-icon {
    width: 44px;
    height: 44px;
    font-size: 1rem;
  }
  
  .cheatsheet-item {
    padding: 14px;
  }
  
  /* Уменьшаем отступы в фильтрах */
  .filters {
    padding: 0 12px 12px;
  }
  
  .filter-row {
    grid-template-columns: 1fr;
    gap: 10px;
  }
}

/* Пейзажная ориентация на телефонах */
@media (max-width: 768px) and (orientation: landscape) {
  .btn-new {
    margin: 10px;
    padding: 10px 12px;
    font-size: 0.85rem;
    width: calc(100% - 20px);
  }
  
  .cheatsheet-item {
    padding: 12px;
    min-height: 60px;
  }
  
  .cheatsheet-title {
    font-size: 0.9rem;
  }
  
  .mobile-menu {
    padding: 10px;
  }
  
  .mobile-menu .btn-icon {
    width: 42px;
    height: 42px;
  }
}

/* Улучшение для касаний */
@media (hover: none) and (pointer: coarse) {
  .btn-new {
    min-height: 48px;
    touch-action: manipulation;
  }
  
  .mobile-menu .btn-icon {
    min-height: 48px;
    min-width: 48px;
  }
}
@media (min-width: 769px) and (max-width: 990px) {
  .mobile-menu {
    display: none !important; /* Скрываем на планшетах */
  }
  
  .sidebar-footer {
    display: flex !important;
  }
}

/* Для десктопов */
@media (min-width: 991px) {
  .mobile-menu {
    display: none !important;
  }
  
  .sidebar-footer {
    display: flex !important;
  }
}
скрипт js 
// Данные приложения
let cheatsheets = JSON.parse(localStorage.getItem('egeCheatsheets')) || [];
let editingId = null;
let currentView = 'list'; // 'list', 'grid', 'view'
let currentFilter = {
    subject: 'all',
    task: 'all',
    search: ''
};
let isEditModalOpen = false;
let selectedCheatsheets = new Set();
let customSubjects = JSON.parse(localStorage.getItem('egeCustomSubjects')) || [];
let currentStep = 1;
let selectedSubject = '';
let selectedTask = '';
let helpModal = document.getElementById('helpModal');
let closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
let prevStepBtn = document.getElementById('prevStepBtn');
let nextStepBtn = document.getElementById('nextStepBtn');
let subjectGrid = document.getElementById('subjectGrid');
let taskGrid = document.getElementById('taskGrid');
let formatBtns = document.querySelectorAll('.format-btn');
let previewSection = document.getElementById('previewSection');
let editPreviewBtn = document.getElementById('editPreviewBtn');
let modalSubtitle = document.getElementById('modalSubtitle');
let formatHelpBtn = document.getElementById('formatHelpBtn');
let tagsInput = document.getElementById('tags');
let statsContainer = document.getElementById('statsContainer');
let subjectStats = document.getElementById('subjectStats');
// DOM элементы
// Константы для настройки
const PREVIEW_MAX_LENGTH = 120;
const LIST_MAX_TAGS = 2;
const cheatsheetList = document.getElementById('cheatsheetList');
const cheatsheetGrid = document.getElementById('cheatsheetGrid');
const contentArea = document.getElementById('contentArea');
const emptyState = document.getElementById('emptyState');
const totalCheatsheets = document.getElementById('totalCheatsheets');
const searchInput = document.getElementById('searchInput');
const subjectFilter = document.getElementById('subjectFilter');
const taskFilter = document.getElementById('taskFilter');
const currentSubject = document.getElementById('currentSubject');
const closeViewBtn = document.getElementById('closeViewBtn');
const cheatsheetView = document.getElementById('cheatsheetView');
const viewTitle = document.getElementById('viewTitle');
const viewSubject = document.getElementById('viewSubject');
const viewTask = document.getElementById('viewTask');
const viewDate = document.getElementById('viewDate');
const viewContent = document.getElementById('viewContent');
const editBtn = document.getElementById('editBtn');
const deleteBtn = document.getElementById('deleteBtn');
const newCheatsheetBtn = document.getElementById('newCheatsheetBtn');
const emptyNewBtn = document.getElementById('emptyNewBtn');
const editModal = document.getElementById('editModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const cancelBtn = document.getElementById('cancelBtn');
const modalTitle = document.getElementById('modalTitle');
const cheatsheetForm = document.getElementById('cheatsheetForm');
const subjectSelect = document.getElementById('subject');
const taskNumberSelect = document.getElementById('taskNumber');
const titleInput = document.getElementById('title');
const contentTextarea = document.getElementById('content');
const charCount = document.getElementById('charCount');
const saveBtn = document.getElementById('saveBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const themeToggle = document.getElementById('themeToggle');
const toastContainer = document.getElementById('toastContainer');
const deleteConfirmModal = document.getElementById('deleteConfirmModal');
const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
const deleteConfirmText = document.getElementById('deleteConfirmText');
const deleteConfirmDetails = document.getElementById('deleteConfirmDetails');
let cheatsheetToDelete = null;
// Элементы модального окна экспорта
const exportModal = document.getElementById('exportModal');
const closeExportModalBtn = document.getElementById('closeExportModalBtn');
const cancelExportBtn = document.getElementById('cancelExportBtn');
const confirmExportBtn = document.getElementById('confirmExportBtn');
const exportAllRadio = document.getElementById('exportAll');
const exportFilteredRadio = document.getElementById('exportFiltered');
const exportSelectedRadio = document.getElementById('exportSelected');
const exportSelection = document.getElementById('exportSelection');
const exportCheckboxes = document.getElementById('exportCheckboxes');
const exportAllCount = document.getElementById('exportAllCount');
const exportFilteredCount = document.getElementById('exportFilteredCount');
const exportSelectedCount = document.getElementById('exportSelectedCount');
// Инициализация приложения
document.addEventListener('DOMContentLoaded', function() {
    if (!subjectGrid || !taskGrid || !editModal) {
        console.error('Не найдены необходимые DOM элементы');
        return;
    }
    initTaskNumbers();
    initSubjects();
    updateStats();
    renderCheatsheets();
    setupEventListeners();
    
    // Проверяем тему
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    if (saveBtn) {
        debounceButtonClick(saveBtn, saveCheatsheet);
    }
    
    if (confirmDeleteBtn) {
        debounceButtonClick(confirmDeleteBtn, confirmDeleteCheatsheet, 500);
    }
    
    if (confirmExportBtn) {
        debounceButtonClick(confirmExportBtn, confirmExport);
    }
    setupMobileView();
    setTimeout(updateCheatsheetListHeight, 100);
    const observer = new MutationObserver(updateCheatsheetListHeight);
    const cheatsheetList = document.querySelector('.cheatsheet-list');
    if (cheatsheetList) {
        observer.observe(cheatsheetList, { childList: true });
    }
    // Скрываем кнопку закрытия просмотра на десктопах
    if (!isMobileDevice()) {
        document.getElementById('closeViewBtn').style.display = 'none';
    }
});
function initSubjects() {
    const subjects = [
        { id: 'Математика', icon: 'fa-calculator', color: '#4361ee' },
        { id: 'Русский язык', icon: 'fa-language', color: '#7209b7' },
        { id: 'Физика', icon: 'fa-atom', color: '#f72585' },
        { id: 'Химия', icon: 'fa-flask', color: '#4cc9f0' },
        { id: 'Биология', icon: 'fa-dna', color: '#2ec4b6' },
        { id: 'Информатика', icon: 'fa-laptop-code', color: '#ff9e00' },
        { id: 'История', icon: 'fa-landmark', color: '#9d4edd' },
        { id: 'Обществознание', icon: 'fa-users', color: '#06d6a0' },
        { id: 'Английский язык', icon: 'fa-globe-europe', color: '#ef476f' },
        { id: 'Литература', icon: 'fa-book-open', color: '#118ab2' },
        { id: 'География', icon: 'fa-globe-americas', color: '#06d6a0' }
    ];
    
    subjectGrid.innerHTML = subjects.map(subject => `
        <button type="button" class="subject-btn" data-subject="${subject.id}">
            <i class="fas ${subject.icon}"></i>
            <span>${subject.id}</span>
        </button>
    `).join('');
    
    // Обработчики для кнопок предметов
    document.querySelectorAll('.subject-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedSubject = btn.dataset.subject;
            updateModalSubtitle();
        });
    });
}
// Заполняем список номеров заданий
function initTaskNumbers() {
    const taskNumbers = Array.from({length: 27}, (_, i) => i + 1);
    
    // Для фильтра
    taskFilter.innerHTML = '<option value="all">Все задания</option>' +
        taskNumbers.map(num => `<option value="${num}">${num}</option>`).join('');
    
    // Для сетки
    taskGrid.innerHTML = taskNumbers.map(num => `
        <button type="button" class="task-btn" data-task="${num}">${num}</button>
    `).join('');
    
    // Обработчики для кнопок заданий
    document.querySelectorAll('.task-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.task-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedTask = btn.dataset.task;
            updateModalSubtitle();
        });
    });
    
    // Инициализируем скрытые селекты для формы (добавляем)
    taskNumberSelect.innerHTML = '<option value="" disabled selected>Выберите номер</option>' +
        taskNumbers.map(num => `<option value="${num}">${num}</option>`).join('');
}
function updateModalSubtitle() {
    if (selectedSubject && selectedTask) {
        modalSubtitle.textContent = `${selectedSubject}, задание ${selectedTask}`;
    } else if (selectedSubject) {
        modalSubtitle.textContent = `Выбран предмет: ${selectedSubject}`;
    } else if (selectedTask) {
        modalSubtitle.textContent = `Выбрано задание: ${selectedTask}`;
    } else {
        modalSubtitle.textContent = 'Заполните информацию о шпаргалке';
    }
}
// Настройка обработчиков событий
// Настройка обработчиков событий
function setupEventListeners() {
    const sidebarFooter = document.querySelector('.sidebar-footer');
    const mobileMenu = document.querySelector('.mobile-menu');
    if (sidebarFooter && mobileMenu) {
        // Показываем оба меню, CSS скроет ненужное
        sidebarFooter.style.display = 'flex';
        mobileMenu.style.display = 'flex';
        
        // Явно назначаем обработчики для мобильных кнопок
        const mobileExportBtn = document.getElementById('mobileExportBtn');
        const mobileImportBtn = document.getElementById('mobileImportBtn');
        const mobileThemeToggle = document.getElementById('mobileThemeToggle');
        
        if (mobileExportBtn) {
            mobileExportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exportBtn.click();
            });
        }
        
        if (mobileImportBtn) {
            mobileImportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                importBtn.click();
            });
        }
        
        if (mobileThemeToggle) {
            mobileThemeToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                themeToggle.click();
            });
        }
    }
    // Форма
    cheatsheetForm.addEventListener('submit', saveCheatsheet);
    contentTextarea.addEventListener('input', updateCharCount);
    
    // Фильтры
    searchInput.addEventListener('input', updateFilters);
    subjectFilter.addEventListener('change', updateFilters);
    taskFilter.addEventListener('change', updateFilters);
    
    // Кнопки
    newCheatsheetBtn.addEventListener('click', () => openEditModal());
    emptyNewBtn.addEventListener('click', () => openEditModal());
    closeViewBtn.addEventListener('click', () => {
        // Снимаем активный класс со всех элементов
        document.querySelectorAll('.cheatsheet-item.active, .grid-item.active').forEach(el => {
            el.classList.remove('active');
        });
        showListView();
    });
    editBtn.addEventListener('click', editCurrentCheatsheet);
    deleteBtn.addEventListener('click', showDeleteConfirmation);
    
    // Модальное окно
    closeModalBtn.addEventListener('click', closeEditModal);
    cancelBtn.addEventListener('click', closeEditModal);
    
    // Управление
    importBtn.addEventListener('click', importCheatsheets);
    themeToggle.addEventListener('click', toggleTheme);
    
    // Улучшенное закрытие модалки при клике вне её
    setupImprovedModalClose(editModal, closeEditModal);
    setupImprovedModalClose(exportModal, closeExportModal);
    setupImprovedModalClose(deleteConfirmModal, closeDeleteModal);
    setupImprovedModalClose(helpModal, closeHelpModal);
    
    nextStepBtn.addEventListener('click', nextStep);
    prevStepBtn.addEventListener('click', prevStep);
    
    // Обработчики форматирования
    formatBtns.forEach(btn => {
        btn.addEventListener('click', () => applyFormatting(btn.dataset.format));
    });
    
    // Предпросмотр
    editPreviewBtn.addEventListener('click', () => goToStep(2));
    
    // Подсказки
    formatHelpBtn.addEventListener('click', openHelpModal);
    closeHelpModalBtn.addEventListener('click', closeHelpModal);
    
    // Обработчик Escape для модальных окон
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (editModal.style.display === 'flex') {
                closeEditModal();
            }
            if (helpModal.style.display === 'flex') {
                closeHelpModal();
            }
            if (exportModal.style.display === 'flex') {
                closeExportModal();
            }
            if (deleteConfirmModal.style.display === 'flex') {
                closeDeleteModal();
            }
        }
    });
    
    exportBtn.addEventListener('click', openExportModal);
    
    // Модальное окно экспорта
    closeExportModalBtn.addEventListener('click', closeExportModal);
    cancelExportBtn.addEventListener('click', closeExportModal);
    confirmExportBtn.addEventListener('click', confirmExport);
    
    // Переключение типа экспорта
    exportAllRadio.addEventListener('change', updateExportSelection);
    exportFilteredRadio.addEventListener('change', updateExportSelection);
    exportSelectedRadio.addEventListener('change', updateExportSelection);
    
    // Следим за изменениями в форме для предпросмотра
    titleInput.addEventListener('input', updatePreview);
    contentTextarea.addEventListener('input', updatePreview);
    tagsInput.addEventListener('input', updatePreview);
    
    // Удаление шпаргалки
    deleteBtn.addEventListener('click', showDeleteConfirmation);
    
    // Модальное окно подтверждения удаления
    cancelDeleteBtn.addEventListener('click', closeDeleteModal);
    confirmDeleteBtn.addEventListener('click', confirmDeleteCheatsheet);
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (deleteConfirmModal.style.display === 'flex') {
                closeDeleteModal();
            }
        }
    });
}
// Улучшенная функция закрытия модального окна при клике вне его
function setupImprovedModalClose(modalElement, closeFunction) {
    let mouseDownInside = false;
    let mouseDownTarget = null;
    
    // Отслеживаем начало клика
    modalElement.addEventListener('mousedown', function(e) {
        mouseDownInside = true;
        mouseDownTarget = e.target;
    });
    
    // Отслеживаем отпускание кнопки мыши
    modalElement.addEventListener('mouseup', function(e) {
        // Проверяем, был ли клик начат и завершен на фоне модального окна
        if (mouseDownInside && mouseDownTarget === e.target && e.target === modalElement) {
            // Ждем немного, чтобы избежать конфликтов с другими событиями
            setTimeout(() => {
                if (modalElement.style.display === 'flex') {
                    closeFunction();
                }
            }, 10);
        }
        // Сбрасываем флаги
        mouseDownInside = false;
        mouseDownTarget = null;
    });
    
    // Также обрабатываем клик, но только если он не начался внутри контента
    modalElement.addEventListener('click', function(e) {
        // Если клик был на самом фоне модалки (не на контенте)
        if (e.target === modalElement) {
            // Проверяем, не было ли начало клика внутри контента
            const modalContent = modalElement.querySelector('.modal-content');
            if (modalContent && modalContent.contains(mouseDownTarget)) {
                // Клик начался внутри контента, не закрываем
                return;
            }
            
            // Задержка для стабильности
            setTimeout(() => {
                if (modalElement.style.display === 'flex') {
                    closeFunction();
                }
            }, 10);
        }
    });
    
    // Сбрасываем флаги при уходе курсора
    modalElement.addEventListener('mouseleave', function() {
        mouseDownInside = false;
        mouseDownTarget = null;
    });
}
function closeDeleteModal() {
    // Проверяем, открыто ли окно
    if (deleteConfirmModal.style.display !== 'flex') return;
    
    // Убираем подсветку
    if (cheatsheetToDelete) {
        const listItem = document.querySelector(`.cheatsheet-item[data-id="${cheatsheetToDelete}"]`);
        const gridItem = document.querySelector(`.grid-item[data-id="${cheatsheetToDelete}"]`);
        
        if (listItem) listItem.classList.remove('deleting-highlight');
        if (gridItem) gridItem.classList.remove('deleting-highlight');
    }
    
    deleteConfirmModal.style.opacity = '0';
    setTimeout(() => {
        deleteConfirmModal.style.display = 'none';
        cheatsheetToDelete = null;
    }, 0);
}
function confirmDeleteCheatsheet() {
    if (!cheatsheetToDelete) return;
    
    // Сразу закрываем модальное окно
    deleteConfirmModal.style.opacity = '0';
    setTimeout(() => {
        deleteConfirmModal.style.display = 'none';
    }, 0);
    
    // Добавляем анимацию удаления к элементам
    const listItem = document.querySelector(`.cheatsheet-item[data-id="${cheatsheetToDelete}"]`);
    const gridItem = document.querySelector(`.grid-item[data-id="${cheatsheetToDelete}"]`);
    
    if (listItem) listItem.classList.add('deleting');
    if (gridItem) gridItem.classList.add('deleting');
    
    // Удаляем шпаргалку из массива сразу (без задержки)
    cheatsheets = cheatsheets.filter(c => c.id !== cheatsheetToDelete);
    
    // Сохраняем в localStorage
    saveToStorage();
    
    // Обновляем интерфейс (но без перерисовки элементов, которые в процессе анимации)
    updateStats();
    
    // Если удаляли просматриваемую шпаргалку, показываем список
    if (cheatsheetView.dataset.id === cheatsheetToDelete) {
        showListView();
    }
    
    // Показываем уведомление с возможностью отмены
    showUndoableToast('Шпаргалка удалена', cheatsheetToDelete);
    
    // Сбрасываем ID через короткую задержку
    setTimeout(() => {
        cheatsheetToDelete = null;
        // Перерисовываем список только после завершения анимации
        renderCheatsheets();
    }, 500); // Соответствует длительности анимации
}
function showUndoableToast(message, cheatsheetId) {
    // Сохраняем копию удаленной шпаргалки
    const deletedCheatsheet = cheatsheets.find(c => c.id === cheatsheetId);
    if (!deletedCheatsheet) return;
    
    lastDeletedCheatsheet = deletedCheatsheet;
    
    // Создаем уведомление с кнопкой отмены
    const toast = document.createElement('div');
    toast.className = 'toast success';
    toast.dataset.id = cheatsheetId;
    
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-trash"></i> ${message}
            <span id="undoCountdown">5</span>с
        </div>
        <button class="toast-undo" id="undoDeleteBtn">
            <i class="fas fa-undo"></i> Отменить
        </button>
        <button class="toast-close">&times;</button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Запускаем таймер для автоматического скрытия
    let countdown = 5;
    const countdownElement = toast.querySelector('#undoCountdown');
    
    const countdownInterval = setInterval(() => {
        countdown--;
        countdownElement.textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            if (toast.parentNode) {
                toast.remove();
                lastDeletedCheatsheet = null;
            }
        }
    }, 1000);
    
    // Обработчик кнопки отмены
    const undoBtn = toast.querySelector('#undoDeleteBtn');
    undoBtn.addEventListener('click', () => {
        undoDelete(deletedCheatsheet);
        clearInterval(countdownInterval);
        toast.remove();
    });
    
    // Обработчик закрытия
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.addEventListener('click', () => {
        clearInterval(countdownInterval);
        toast.remove();
        lastDeletedCheatsheet = null;
    });
    
    // Автоматическое удаление через 5 секунд
    undoTimeout = setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
            lastDeletedCheatsheet = null;
        }
    }, 5000);
}
function undoDelete(cheatsheet) {
    if (!cheatsheet) return;
    
    // Убираем класс удаления с элементов (если они еще есть в DOM)
    const listItem = document.querySelector(`.cheatsheet-item[data-id="${cheatsheet.id}"]`);
    const gridItem = document.querySelector(`.grid-item[data-id="${cheatsheet.id}"]`);
    
    if (listItem) listItem.classList.remove('deleting');
    if (gridItem) gridItem.classList.remove('deleting');
    
    // Восстанавливаем шпаргалку в массив
    cheatsheets.unshift(cheatsheet);
    
    // Сохраняем в localStorage
    saveToStorage();
    
    // Обновляем интерфейс
    updateStats();
    renderCheatsheets();
    
    // Показываем уведомление о восстановлении
    showToast('Шпаргалка восстановлена', 'success');
    
    // Показываем восстановленную шпаргалку
    const restoredItem = document.querySelector(`.cheatsheet-item[data-id="${cheatsheet.id}"]`);
    if (restoredItem) {
        restoredItem.click();
    }
    
    lastDeletedCheatsheet = null;
}
const undoToastStyles = `
.toast .toast-content i.fa-trash {
    margin-right: 8px;
    color: var(--danger-color);
}

.toast #undoCountdown {
    display: inline-block;
    background-color: rgba(255, 71, 87, 0.2);
    color: var(--danger-color);
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-left: 8px;
    min-width: 24px;
    text-align: center;
}

.toast-undo {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    margin-right: 8px;
    border-radius: var(--radius-sm);
    transition: var(--transition);
}

.toast-undo:hover {
    background-color: rgba(67, 97, 238, 0.1);
    transform: translateY(-1px);
}

.toast-undo i {
    font-size: 0.9rem;
}
`;
const styleSheet = document.createElement('style');
styleSheet.textContent = undoToastStyles;
document.head.appendChild(styleSheet);
let lastDeletedCheatsheet = null;
let undoTimeout = null;
function showDeleteConfirmation() {
    const cheatsheetId = cheatsheetView.dataset.id;
    const cheatsheet = cheatsheets.find(c => c.id === cheatsheetId);
    
    if (!cheatsheet) return;
    
    // Сохраняем ID шпаргалки для удаления
    cheatsheetToDelete = cheatsheetId;
    
    // Подсвечиваем удаляемую шпаргалку в списке
    const listItem = document.querySelector(`.cheatsheet-item[data-id="${cheatsheetId}"]`);
    const gridItem = document.querySelector(`.grid-item[data-id="${cheatsheetId}"]`);
    
    if (listItem) listItem.classList.add('deleting-highlight');
    if (gridItem) gridItem.classList.add('deleting-highlight');
    
    // Красивое описание для удаления
    const taskTypes = {
        1: "задание с кратким ответом",
        2: "задание на анализ текста",
        3: "задание на соответствие",
        4: "задание с развернутым ответом",
        5: "задание на решение задач"
    };
    
    const taskType = taskTypes[cheatsheet.taskNumber] || "задание";
    
    deleteConfirmText.innerHTML = `
        <strong>${cheatsheet.title}</strong> будет удалена без возможности восстановления.<br>
        Это ${taskType} по предмету <strong>${cheatsheet.subject}</strong>.
    `;
    
    // Форматируем даты красиво
    const createdDate = new Date(cheatsheet.createdAt).toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const updatedDate = new Date(cheatsheet.updatedAt).toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'long',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Добавляем красивые детали
    deleteConfirmDetails.innerHTML = `
        <div class="confirm-details-item">
            <span class="confirm-details-label">
                <i class="fas fa-book"></i> Предмет
            </span>
            <span class="confirm-details-value" style="color: var(--primary-color); font-weight: 700;">
                ${cheatsheet.subject}
            </span>
        </div>
        <div class="confirm-details-item">
            <span class="confirm-details-label">
                <i class="fas fa-tasks"></i> Номер задания
            </span>
            <span class="confirm-details-value" style="background: linear-gradient(135deg, var(--secondary-color), var(--secondary-light)); color: white; padding: 4px 12px; border-radius: 20px;">
                ${cheatsheet.taskNumber}
            </span>
        </div>
        <div class="confirm-details-item">
            <span class="confirm-details-label">
                <i class="fas fa-calendar-plus"></i> Создано
            </span>
            <span class="confirm-details-value">${createdDate}</span>
        </div>
        <div class="confirm-details-item">
            <span class="confirm-details-label">
                <i class="fas fa-history"></i> Обновлено
            </span>
            <span class="confirm-details-value">${updatedDate}</span>
        </div>
        <div class="confirm-details-item">
            <span class="confirm-details-label">
                <i class="fas fa-text-height"></i> Размер
            </span>
            <span class="confirm-details-value">
                ${cheatsheet.content.length} символов, 
                ${Math.ceil(cheatsheet.content.split(' ').length)} слов
            </span>
        </div>
    `;
    
    // Показываем модальное окно
    deleteConfirmModal.style.display = 'flex';
    setTimeout(() => {
        deleteConfirmModal.style.opacity = '1';
        confirmDeleteBtn.focus();
    }, 10);
}
// Обновление фильтров
function updateFilters() {
    currentFilter.subject = subjectFilter.value;
    currentFilter.task = taskFilter.value;
    currentFilter.search = searchInput.value.toLowerCase().trim();
    
    updateCurrentSubjectText();
    renderCheatsheets(); // Уже есть
    
    // Обновляем активный элемент, если есть
    if (currentView === 'view' && cheatsheetView.dataset.id) {
        const activeCheatsheet = cheatsheets.find(c => c.id === cheatsheetView.dataset.id);
        if (activeCheatsheet && getFilteredCheatsheets().some(c => c.id === activeCheatsheet.id)) {
            // Если активная шпаргалка проходит фильтр, обновляем её отображение
            viewCheatsheet(activeCheatsheet);
        } else {
            // Иначе возвращаемся к списку
            showListView();
        }
    }
}

// Обновление текста текущего предмета
function updateCurrentSubjectText() {
    if (currentFilter.subject === 'all') {
        currentSubject.textContent = 'Все шпаргалки';
    } else {
        currentSubject.textContent = currentFilter.subject;
    }
}
function nextStep() {
    if (currentStep === 1) {
        // Проверяем, выбраны ли предмет и задание
        if (!selectedSubject || !selectedTask) {
            showToast('Выберите предмет и номер задания', 'error');
            return;
        }
        
        // Заполняем скрытые select'ы для обратной совместимости
        if (subjectSelect) subjectSelect.value = selectedSubject;
        if (taskNumberSelect) taskNumberSelect.value = selectedTask;
        
        // Переходим к шагу 2
        goToStep(2);
    } else if (currentStep === 2) {
        // Проверяем содержание
        if (!contentTextarea.value.trim()) {
            showToast('Введите содержание шпаргалки', 'error');
            return;
        }
        
        // Обновляем предпросмотр
        updatePreview();
        
        // Переходим к шагу 3
        goToStep(3);
    }
}
function prevStep() {
    if (currentStep === 2) {
        goToStep(1);
    } else if (currentStep === 3) {
        goToStep(2);
    }
}
function goToStep(step) {
    // Скрываем все секции
    document.querySelectorAll('.form-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Обновляем степпер
    document.querySelectorAll('.stepper-step').forEach(stepEl => {
        stepEl.classList.remove('active');
        if (parseInt(stepEl.dataset.step) <= step) {
            stepEl.classList.add('active');
        }
    });
    
    // Показываем нужную секцию
    document.getElementById(`${['basic', 'content', 'preview'][step-1]}Section`).style.display = 'block';
    
    // Обновляем кнопки
    prevStepBtn.style.display = step > 1 ? 'flex' : 'none';
    nextStepBtn.style.display = step < 3 ? 'flex' : 'none';
    saveBtn.style.display = step === 3 ? 'flex' : 'none';
    
    // Обновляем заголовок
    modalTitle.textContent = step === 1 ? 'Новая шпаргалка' : 
                           step === 2 ? 'Содержание шпаргалки' : 
                           'Предпросмотр и сохранение';
    
    currentStep = step;
    
    // Если это последний шаг, обновляем статистику символов
    if (step === 2) {
        updateTextStats();
    }
}

// Обновление счетчика символов
function updateCharCount() {
    const length = contentTextarea.value.length;
    charCount.textContent = length;
}
function applyFormatting(format) {
    const textarea = contentTextarea;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    const lineStart = textarea.value.lastIndexOf('\n', start - 1) + 1;
    const lineEnd = textarea.value.indexOf('\n', end);
    const currentLine = lineEnd === -1 
        ? textarea.value.substring(lineStart)
        : textarea.value.substring(lineStart, lineEnd);
    
    let formattedText = '';
    
    switch(format) {
        case 'bold':
            formattedText = `**${selectedText}**`;
            break;
        case 'italic':
            formattedText = `*${selectedText}*`;
            break;
        case 'header':
            // Если строка уже начинается с #, удаляем заголовок
            if (currentLine.startsWith('# ')) {
                formattedText = currentLine.substring(2);
                textarea.setRangeText(formattedText, lineStart, lineEnd === -1 ? textarea.value.length : lineEnd, 'end');
            } else {
                formattedText = `# ${currentLine}`;
                textarea.setRangeText(formattedText, lineStart, lineEnd === -1 ? textarea.value.length : lineEnd, 'end');
            }
            textarea.focus();
            textarea.dispatchEvent(new Event('input'));
            return;
        case 'list':
            // Если выделен текст, применяем к каждой строке
            if (selectedText) {
                formattedText = selectedText.split('\n').map(line => `• ${line}`).join('\n');
            } else {
                // Если курсор в начале строки, добавляем маркер
                if (currentLine.startsWith('• ')) {
                    formattedText = currentLine.substring(2);
                    textarea.setRangeText(formattedText, lineStart, lineEnd === -1 ? textarea.value.length : lineEnd, 'end');
                } else {
                    formattedText = `• ${currentLine}`;
                    textarea.setRangeText(formattedText, lineStart, lineEnd === -1 ? textarea.value.length : lineEnd, 'end');
                }
                textarea.focus();
                textarea.dispatchEvent(new Event('input'));
                return;
            }
            break;
        case 'code':
            formattedText = `\`${selectedText}\``;
            break;
        case 'clear':
            formattedText = selectedText.replace(/\*\*|\*|`{1,3}|^[•\-]\s+/gm, '');
            break;
    }
    
    textarea.setRangeText(formattedText, start, end, 'end');
    textarea.focus();
    textarea.dispatchEvent(new Event('input'));
}


function updateTextStats() {
    const text = contentTextarea.value;
    const charCountElement = document.getElementById('charCount');
    const wordCountElement = document.getElementById('wordCount');
    const lineCountElement = document.getElementById('lineCount');
    
    // Символы
    const chars = text.length;
    charCountElement.textContent = chars;
    
    // Слова
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    wordCountElement.textContent = words;
    
    // Строки
    const lines = text ? text.split('\n').length : 0;
    lineCountElement.textContent = lines;
}
// Закрытие модального окна
function closeEditModal() {
    // Проверяем, открыто ли окно
    if (editModal.style.display !== 'flex') return;
    
    isEditModalOpen = false;
    editModal.style.opacity = '0';
    setTimeout(() => {
        editModal.style.display = 'none';
        editingId = null;
        selectedSubject = '';
        selectedTask = '';
        
        // Сбрасываем активные кнопки
        document.querySelectorAll('.subject-btn, .task-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Сбрасываем форму
        cheatsheetForm.reset();
        
        // Сбрасываем шаги
        goToStep(1);
    }, 0);
}
function updatePreview() {
    // Обновляем статистику текста
    updateTextStats();
    
    // Обновляем предпросмотр
    document.getElementById('previewSubject').textContent = selectedSubject;
    document.getElementById('previewTask').textContent = `Задание ${selectedTask}`;
    
    const title = titleInput.value.trim() || `${selectedSubject}, задание ${selectedTask}`;
    document.getElementById('previewTitle').textContent = title;
    
    // Форматируем содержимое с помощью formatContent для правильного отображения
    const formattedContent = formatContent(contentTextarea.value);
    document.getElementById('previewContent').innerHTML = formattedContent;
    
    // Обновляем теги
    const tagsContainer = document.getElementById('previewTags');
    const tags = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);
    
    if (tags.length > 0) {
        tagsContainer.innerHTML = tags.map(tag => 
            `<span class="preview-tag">${tag}</span>`
        ).join('');
    } else {
        tagsContainer.innerHTML = '<span class="preview-tag">без тегов</span>';
    }
}
// Сохранение шпаргалки

function openHelpModal() {
    helpModal.style.display = 'flex';
    setTimeout(() => helpModal.style.opacity = '1', 10);
}

// Закрытие модального окна с подсказками
function closeHelpModal() {
    // Проверяем, открыто ли окно
    if (helpModal.style.display !== 'flex') return;
    
    helpModal.style.opacity = '0';
    setTimeout(() => {
        helpModal.style.display = 'none';
    },0);
}
function debounceButtonClick(button, callback, delay = 300) {
    let isProcessing = false;
    
    button.addEventListener('click', function(e) {
        if (isProcessing) {
            e.preventDefault();
            e.stopPropagation();
            return;
        }
        
        isProcessing = true;
        
        // Визуальная обратная связь
        button.classList.add('processing');
        
        // Выполняем callback
        if (typeof callback === 'function') {
            callback(e);
        }
        
        // Сбрасываем через delay миллисекунд
        setTimeout(() => {
            isProcessing = false;
            button.classList.remove('processing');
        }, delay);
    });
}
// Обновление статистики (расширенная версия)
function updateStats() {
    const total = cheatsheets.length;
    
    // Обновляем общее количество с правильным склонением
    const word = getWordForm(total, ['шпаргалка', 'шпаргалки', 'шпаргалок']);
    document.getElementById('totalCheatsheets').textContent = total;
    document.querySelector('.stats-label').textContent = word;
    
    // Показываем статистику по предметам
    if (total > 0) {
        const subjectCounts = {};
        cheatsheets.forEach(c => {
            subjectCounts[c.subject] = (subjectCounts[c.subject] || 0) + 1;
        });
        
        // Сортируем по количеству
        const sortedSubjects = Object.entries(subjectCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 3); // Показываем только топ-3
        
        if (sortedSubjects.length > 0) {
            const statsText = sortedSubjects.map(([subject, count]) => 
                `${subject}: ${count}`
            ).join(', ');
            
            subjectStats.textContent = statsText;
            subjectStats.style.display = 'block';
        } else {
            subjectStats.style.display = 'none';
        }
    } else {
        subjectStats.style.display = 'none';
    }
    
    // Обновляем внешний вид контейнера статистики
    statsContainer.classList.toggle('has-stats', total > 0);
}

// Функция для склонения слов
function getWordForm(number, forms) {
    const n = Math.abs(number) % 100;
    const n1 = n % 10;
    
    if (n > 10 && n < 20) return forms[2];
    if (n1 > 1 && n1 < 5) return forms[1];
    if (n1 === 1) return forms[0];
    return forms[2];
}

// Обновляем функцию openEditModal
function openEditModal(cheatsheet = null) {
    // Сбрасываем форму
    isEditModalOpen = true;
    currentStep = 1;
    selectedSubject = '';
    selectedTask = '';
    
    document.querySelectorAll('.subject-btn, .task-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if (cheatsheet) {
        // Редактирование существующей
        editingId = cheatsheet.id;
        modalTitle.textContent = 'Редактировать шпаргалку';
        
        // Выбираем предмет
        const subjectBtn = document.querySelector(`.subject-btn[data-subject="${cheatsheet.subject}"]`);
        if (subjectBtn) {
            subjectBtn.classList.add('active');
            selectedSubject = cheatsheet.subject;
        }
        
        // Выбираем задание
        const taskBtn = document.querySelector(`.task-btn[data-task="${cheatsheet.taskNumber}"]`);
        if (taskBtn) {
            taskBtn.classList.add('active');
            selectedTask = String(cheatsheet.taskNumber);
        }
        
        titleInput.value = cheatsheet.title || '';
        contentTextarea.value = cheatsheet.content;
        tagsInput.value = cheatsheet.tags ? cheatsheet.tags.join(', ') : '';
        
        // Заполняем скрытые поля для обратной совместимости
        if (subjectSelect) subjectSelect.value = cheatsheet.subject;
        if (taskNumberSelect) taskNumberSelect.value = String(cheatsheet.taskNumber);
    } else {
        // Создание новой
        editingId = null;
        modalTitle.textContent = 'Новая шпаргалка';
        cheatsheetForm.reset();
        
        // Сбрасываем скрытые селекты
        if (subjectSelect) subjectSelect.value = '';
        if (taskNumberSelect) taskNumberSelect.value = '';
    }
    
    // Обновляем подзаголовок
    updateModalSubtitle();
    
    // Сбрасываем к шагу 1
    goToStep(1);
    
    // Показываем модальное окно
    editModal.style.display = 'flex';
    setTimeout(() => {
        editModal.style.opacity = '1';
        contentTextarea.focus();
    }, 10);
}

// Обновляем функцию saveCheatsheet для поддержки тегов
function saveCheatsheet(e) {
    e.preventDefault();
    
    // Валидация
    if (!selectedSubject || !selectedTask) {
        showToast('Выберите предмет и номер задания', 'error');
        goToStep(1);
        return;
    }
    
    const title = titleInput.value.trim();
    const content = contentTextarea.value.trim();
    const tags = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);
    
    if (!content) {
        showToast('Введите содержание шпаргалки', 'error');
        goToStep(2);
        return;
    }
    
    // Преобразуем selectedTask в число
    const taskNumber = parseInt(selectedTask);
    
    let updatedCheatsheet;
    
    if (editingId) {
        // Обновление существующей
        const index = cheatsheets.findIndex(c => c.id === editingId);
        if (index !== -1) {
            cheatsheets[index] = {
                ...cheatsheets[index],
                subject: selectedSubject,
                taskNumber: taskNumber,
                title: title || `${selectedSubject}, задание ${selectedTask}`,
                content,
                tags,
                updatedAt: new Date().toISOString()
            };
            updatedCheatsheet = cheatsheets[index];
        }
    } else {
        // Создание новой
        const newCheatsheet = {
            id: Date.now().toString(),
            subject: selectedSubject,
            taskNumber: taskNumber,
            title: title || `${selectedSubject}, задание ${selectedTask}`,
            content,
            tags,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        cheatsheets.unshift(newCheatsheet);
        updatedCheatsheet = newCheatsheet;
    }
    
    // Сохраняем в localStorage
    saveToStorage();
    
    // Обновляем интерфейс
    updateStats();
    renderCheatsheets();
    closeEditModal();
    
    // Если редактировали шпаргалку, которая сейчас открыта в режиме просмотра, обновляем её
    if (editingId && cheatsheetView.dataset.id === editingId && updatedCheatsheet) {
        viewCheatsheet(updatedCheatsheet);
    }
    
    // Показываем уведомление
    showToast(
        editingId ? 'Шпаргалка обновлена' : 'Шпаргалка создана',
        'success'
    );
}


// Обновляем событие input для contentTextarea
contentTextarea.addEventListener('input', function() {
    updateTextStats();
    updatePreview();
});
// Сохранение в localStorage
function saveToStorage() {
    try {
        localStorage.setItem('egeCheatsheets', JSON.stringify(cheatsheets));
        return true;
    } catch (error) {
        if (error.name === 'QuotaExceededError') {
            showToast('Превышен лимит хранилища. Удалите некоторые шпаргалки.', 'error');
        }
        return false;
    }
}

// Отображение шпаргалок
function renderCheatsheets() {
    let filteredCheatsheets = getFilteredCheatsheets();
    totalCheatsheets.textContent = filteredCheatsheets.length;
    if (filteredCheatsheets.length === 0) {
        showEmptyState();
        // Очищаем список
        cheatsheetList.innerHTML = '';
        cheatsheetGrid.innerHTML = '';
        return;
    }
    if (currentView !== 'view') {
        showListView();
    }
    
    // Очищаем списки
    cheatsheetList.innerHTML = '';
    cheatsheetGrid.innerHTML = '';
    
    // Добавляем шпаргалки
    filteredCheatsheets.forEach(cheatsheet => {
        renderCheatsheetItem(cheatsheet);
        renderGridItem(cheatsheet);
    });
    setTimeout(updateCheatsheetListHeight, 100);
}

// Рендер элемента списка
// Рендер элемента списка (без превью текста)
function renderCheatsheetItem(cheatsheet) {
    const item = document.createElement('div');
    item.className = 'cheatsheet-item';
    item.dataset.id = cheatsheet.id;
    
    // Форматируем дату
    const date = formatDate(cheatsheet.updatedAt || cheatsheet.createdAt);
    
    // Определяем иконку предмета
    const subjectIcons = {
        'Математика': 'fa-calculator',
        'Русский язык': 'fa-language',
        'Физика': 'fa-atom',
        'Химия': 'fa-flask',
        'Биология': 'fa-dna',
        'Информатика': 'fa-laptop-code',
        'История': 'fa-landmark',
        'Обществознание': 'fa-users',
        'Английский язык': 'fa-globe-europe',
        'Литература': 'fa-book-open',
        'География': 'fa-globe-americas'
    };
    
    const iconClass = subjectIcons[cheatsheet.subject] || 'fa-book';
    
    // Теги для отображения в meta
    const tagsDisplay = cheatsheet.tags && cheatsheet.tags.length > 0 
        ? `<div class="cheatsheet-tags">${cheatsheet.tags.slice(0, 3).map(tag => 
            `<span class="cheatsheet-tag">${tag}</span>`).join('')}</div>`
        : '';
    

    
    item.innerHTML = `
        <div class="cheatsheet-item-header">
            <div class="cheatsheet-subject-icon">
                <i class="fas ${iconClass}"></i>
            </div>
            <div class="cheatsheet-info">
                <div class="cheatsheet-title">${cheatsheet.title}</div>
                <div class="cheatsheet-subject-task">
                    <span class="cheatsheet-subject">${cheatsheet.subject}</span>
                    <span class="cheatsheet-task">Задание ${cheatsheet.taskNumber}</span>
                </div>
                
            </div>
        </div>
        <div class="cheatsheet-meta">
            <span>${date}</span>
            <span class="cheatsheet-tags-meta">${tagsDisplay}</span>
        </div>
    `;
    
    item.addEventListener('click', () => {
        document.querySelectorAll('.cheatsheet-item').forEach(el => {
            el.classList.remove('active');
        });
        item.classList.add('active');
        viewCheatsheet(cheatsheet);
    });
    
    cheatsheetList.appendChild(item);
}
function formatContent(content) {
    if (!content) return '';
    
    let formatted = content;
    
    // Сначала обрабатываем блоки кода, чтобы не трогать их содержимое
    // Блок кода: ```код```
    formatted = formatted.replace(/```\s*([\s\S]*?)\s*```/g, '<pre><code>$1</code></pre>');
    
    // Обрабатываем остальное форматирование построчно
    let lines = formatted.split('\n');
    let resultLines = [];
    let inList = false;
    let listItems = [];
    
    for (let line of lines) {
        // Проверяем, не является ли строка блоком кода
        if (line.includes('```')) {
            if (inList && listItems.length > 0) {
                resultLines.push(`<ul class="formatted-list">${listItems.join('')}</ul>`);
                listItems = [];
                inList = false;
            }
            resultLines.push(line);
            continue;
        }
        
        // Заголовки: # Заголовок, ## Подзаголовок
        if (line.startsWith('## ')) {
            if (inList && listItems.length > 0) {
                resultLines.push(`<ul class="formatted-list">${listItems.join('')}</ul>`);
                listItems = [];
                inList = false;
            }
            line = `<h4>${line.substring(3)}</h4>`;
            resultLines.push(line);
        }
        else if (line.startsWith('# ')) {
            if (inList && listItems.length > 0) {
                resultLines.push(`<ul class="formatted-list">${listItems.join('')}</ul>`);
                listItems = [];
                inList = false;
            }
            line = `<h3>${line.substring(2)}</h3>`;
            resultLines.push(line);
        }
        // Горизонтальная линия
        else if (line === '---') {
            if (inList && listItems.length > 0) {
                resultLines.push(`<ul class="formatted-list">${listItems.join('')}</ul>`);
                listItems = [];
                inList = false;
            }
            line = '<hr>';
            resultLines.push(line);
        }
        // Элемент списка
        else if (line.startsWith('• ') || line.startsWith('- ')) {
            const listSymbol = line.startsWith('• ') ? '•' : '-';
            if (!inList) {
                inList = true;
            }
            
            // Убираем маркер списка и обрабатываем форматирование внутри
            let itemText = line.substring(2);
            itemText = itemText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            itemText = itemText.replace(/\*(.*?)\*/g, '<em>$1</em>');
            itemText = itemText.replace(/`(.*?)`/g, '<code>$1</code>');
            
            listItems.push(`<li>${itemText}</li>`);
        }
        // Не элемент списка, но список активен
        else if (inList && line.trim() !== '' && !line.startsWith('• ') && !line.startsWith('- ')) {
            if (listItems.length > 0) {
                resultLines.push(`<ul class="formatted-list">${listItems.join('')}</ul>`);
                listItems = [];
            }
            inList = false;
            
            // Добавляем текущую строку
            line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            line = line.replace(/\*(.*?)\*/g, '<em>$1</em>');
            line = line.replace(/`(.*?)`/g, '<code>$1</code>');
            resultLines.push(line);
        }
        // Не элемент списка и список не активен
        else if (!inList && line.trim() !== '') {
            // Жирный текст: **текст**
            line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Курсив: *текст*
            line = line.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Код: `текст`
            line = line.replace(/`(.*?)`/g, '<code>$1</code>');
            resultLines.push(line);
        }
        // Пустая строка
        else if (line.trim() === '') {
            if (inList && listItems.length > 0) {
                resultLines.push(`<ul class="formatted-list">${listItems.join('')}</ul>`);
                listItems = [];
                inList = false;
            }
            resultLines.push('<br>');
        }
    }
    
    // Закрываем список, если он остался открытым
    if (inList && listItems.length > 0) {
        resultLines.push(`<ul class="formatted-list">${listItems.join('')}</ul>`);
    }
    
    formatted = resultLines.join('\n');
    
    return formatted;
}
// Рендер элемента сетки
// Рендер элемента сетки
function renderGridItem(cheatsheet) {
    const item = document.createElement('div');
    item.className = 'grid-item';
    item.dataset.id = cheatsheet.id;
    
    // Форматируем дату
    const date = formatDateShort(cheatsheet.updatedAt || cheatsheet.createdAt);
    
    // Убираем форматирование из превью
    const cleanPreview = cheatsheet.content
        .replace(/\*\*(.*?)\*\*/g, '$1')
        .replace(/\*(.*?)\*/g, '$1')
        .replace(/`(.*?)`/g, '$1')
        .replace(/```\s*([\s\S]*?)\s*```/g, '$1')
        .replace(/^•\s+/gm, '')
        .replace(/\n/g, ' ');
    
    const preview = cleanPreview.length > 120 
        ? cleanPreview.substring(0, 120) + '...' 
        : cleanPreview;
    
    item.innerHTML = `
        <div class="grid-title">${cheatsheet.title}</div>
        <div class="grid-preview">${preview}</div>
        <div class="grid-meta">
            <span>${cheatsheet.subject} • Задание ${cheatsheet.taskNumber}</span>
            <span>${date}</span>
        </div>
    `;
    
    item.addEventListener('click', () => viewCheatsheet(cheatsheet));
    cheatsheetGrid.appendChild(item);
}

// Просмотр шпаргалки
function viewCheatsheet(cheatsheet) {
    if (isMobileDevice() && !document.querySelector('.main-content').classList.contains('mobile-active')) {
        return;
    }
    currentView = 'view';
    
    // Обновляем данные
    viewTitle.textContent = cheatsheet.title;
    viewSubject.textContent = cheatsheet.subject;
    viewTask.textContent = `Задание ${cheatsheet.taskNumber}`;
    viewDate.textContent = formatDate(cheatsheet.updatedAt || cheatsheet.createdAt);
    
    // Форматируем содержимое
    const formattedContent = formatContent(cheatsheet.content);
    viewContent.innerHTML = formattedContent;
    
    // Сохраняем ID для редактирования/удаления
    cheatsheetView.dataset.id = cheatsheet.id;
    
    // Показываем режим просмотра
    showCheatsheetView();
    
    // Обновляем активный элемент в списке
    document.querySelectorAll('.cheatsheet-item, .grid-item').forEach(el => {
        el.classList.remove('active');
        if (el.dataset.id === cheatsheet.id) {
            el.classList.add('active');
        }
    });
}


// Показать пустое состояние
function showEmptyState() {
    emptyState.style.display = 'flex';
    cheatsheetGrid.style.display = 'none';
    cheatsheetView.style.display = 'none';
    closeViewBtn.style.display = 'none';
}

// Показать список
function showListView() {
    if (isMobileDevice()) {
        return mobileShowListView();
    }
    currentView = 'list';
    emptyState.style.display = 'none';
    cheatsheetGrid.style.display = 'grid';
    cheatsheetView.style.display = 'none';
    closeViewBtn.style.display = 'none';
}

// Показать просмотр шпаргалки
function showCheatsheetView() {
    emptyState.style.display = 'none';
    cheatsheetGrid.style.display = 'none';
    cheatsheetView.style.display = 'block';
    closeViewBtn.style.display = 'flex';
}

// Редактирование текущей шпаргалки
function editCurrentCheatsheet() {
    const cheatsheetId = cheatsheetView.dataset.id;
    const cheatsheet = cheatsheets.find(c => c.id === cheatsheetId);
    
    if (cheatsheet) {
        openEditModal(cheatsheet);
    }
}

// Удаление текущей шпаргалки


// Экспорт шпаргалок
function exportCheatsheets(cheatsheetsToExport = null) {
    const exportData = cheatsheetsToExport || cheatsheets;
    
    if (exportData.length === 0) {
        showToast('Нет шпаргалок для экспорта', 'warning');
        return;
    }
    
    const data = {
        version: '1.0',
        exportedAt: new Date().toISOString(),
        count: exportData.length,
        cheatsheets: exportData
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `шпаргалки_еге_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    URL.revokeObjectURL(url);
    showToast(`Экспортировано ${exportData.length} шпаргалок`, 'success');
}
function exportSelectedCheatsheets(selectedIds) {
    if (!selectedIds || selectedIds.length === 0) {
        showToast('Не выбраны шпаргалки для экспорта', 'warning');
        return false;
    }
    
    // Фильтруем шпаргалки по выбранным ID
    const selectedCheatsheets = cheatsheets.filter(cheatsheet => 
        selectedIds.includes(cheatsheet.id)
    );
    
    if (selectedCheatsheets.length === 0) {
        showToast('Выбранные шпаргалки не найдены', 'error');
        return false;
    }
    
    // Создаем объект для экспорта
    const exportData = {
        version: '1.1',
        exportedAt: new Date().toISOString(),
        count: selectedCheatsheets.length,
        exportType: 'selected',
        selectedIds: selectedIds,
        cheatsheets: selectedCheatsheets
    };
    
    // Преобразуем в JSON
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // Создаем ссылку для скачивания
    const a = document.createElement('a');
    a.href = url;
    a.download = `выбранные_шпаргалки_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // Освобождаем память
    URL.revokeObjectURL(url);
    
    showToast(`Экспортировано ${selectedCheatsheets.length} выбранных шпаргалок`, 'success');
    return true;
}
function exportFilteredCheatsheets() {
    const filteredCheatsheets = getFilteredCheatsheets();
    
    if (filteredCheatsheets.length === 0) {
        showToast('Нет отфильтрованных шпаргалок для экспорта', 'warning');
        return false;
    }
    
    const exportData = {
        version: '1.1',
        exportedAt: new Date().toISOString(),
        count: filteredCheatsheets.length,
        exportType: 'filtered',
        filter: { ...currentFilter },
        cheatsheets: filteredCheatsheets
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `отфильтрованные_шпаргалки_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    URL.revokeObjectURL(url);
    showToast(`Экспортировано ${filteredCheatsheets.length} отфильтрованных шпаргалок`, 'success');
    return true;
}


// Импорт шпаргалок
function importCheatsheets() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            // Проверяем формат
            let importedCheatsheets;
            if (data.cheatsheets && Array.isArray(data.cheatsheets)) {
                importedCheatsheets = data.cheatsheets;
            } else if (Array.isArray(data)) {
                importedCheatsheets = data;
            } else {
                throw new Error('Неверный формат файла');
            }
            
            // Добавляем новые ID
            importedCheatsheets.forEach(c => {
                c.id = Date.now() + Math.random().toString(36).substr(2, 9);
                if (!c.createdAt) c.createdAt = new Date().toISOString();
                if (!c.updatedAt) c.updatedAt = new Date().toISOString();
            });
            
            // Добавляем к существующим
            cheatsheets = [...importedCheatsheets, ...cheatsheets];
            saveToStorage();
            updateStats();
            renderCheatsheets();
            
            showToast(`Импортировано ${importedCheatsheets.length} шпаргалок`, 'success');
        } catch (error) {
            showToast('Ошибка при импорте файла', 'error');
        }
    };
    
    input.click();
}

// Переключение темы
function toggleTheme() {
    const isDark = !document.body.classList.contains('light-theme');
    
    if (isDark) {
        document.body.classList.add('light-theme');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        localStorage.setItem('theme', 'light');
    } else {
        document.body.classList.remove('light-theme');
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        localStorage.setItem('theme', 'dark');
    }
}

// Форматирование даты
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    // Если сегодня
    if (diff < 86400000) {
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Если вчера
    if (diff < 172800000) {
        return 'Вчера, ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Старше
    return date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'short',
        year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
    });
}

function formatDateShort(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    // Если сегодня
    if (diff < 86400000) {
        return 'сегодня';
    }
    
    // Если вчера
    if (diff < 172800000) {
        return 'вчера';
    }
    
    // Если на этой неделе
    if (diff < 604800000) {
        const days = ['вс', 'пн', 'вт', 'ср', 'чт', 'пт', 'сб'];
        return days[date.getDay()];
    }
    
    // Старше
    return date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'short'
    });
}

// Обновление статистики


// Показать уведомление
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-content">${message}</div>
        <button class="toast-close">&times;</button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Закрытие
    toast.querySelector('.toast-close').addEventListener('click', () => {
        toast.remove();
    });
    
    // Автоматическое закрытие
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// Сохраняем данные при закрытии вкладки
window.addEventListener('beforeunload', () => {
    if (contentTextarea.value.trim() && editingId && isEditModalOpen) {
        saveCheatsheet({ preventDefault: () => {} });
    }
});
// Функции для работы с экспортом
function openExportModal() {
    // Обновляем счетчики
    exportAllCount.textContent = cheatsheets.length;
    
    const filteredCheatsheets = getFilteredCheatsheets();
    exportFilteredCount.textContent = filteredCheatsheets.length;
    
    // Считаем только те выбранные, которые есть в отфильтрованных
    const filteredSelectedCount = Array.from(selectedCheatsheets).filter(id => 
        filteredCheatsheets.some(c => c.id === id)
    ).length;
    exportSelectedCount.textContent = filteredSelectedCount;
    
    // Заполняем чекбоксы
    populateExportCheckboxes();
    
    // Сбрасываем выбор типа экспорта
    if (exportAllRadio) exportAllRadio.checked = true;
    updateExportSelection();
    
    // Сбрасываем стили прокрутки
    const modalBody = exportModal.querySelector('.modal-body');
    if (modalBody) {
        modalBody.classList.remove('scrollable');
    }
    
    // Показываем модальное окно
    exportModal.style.display = 'flex';
    setTimeout(() => {
        exportModal.style.opacity = '1';
    }, 10);
}

function closeExportModal() {
    // Проверяем, открыто ли окно
    if (exportModal.style.display !== 'flex') return;
    
    exportModal.style.opacity = '0';
    setTimeout(() => {
        exportModal.style.display = 'none';
        
        // Сбрасываем стили прокрутки
        const modalBody = exportModal.querySelector('.modal-body');
        if (modalBody) {
            modalBody.classList.remove('scrollable');
            modalBody.style.overflowY = '';
            modalBody.style.maxHeight = '';
        }
        
        // Сбрасываем стили блока выбора
        if (exportSelection) {
            exportSelection.style.maxHeight = '';
            exportSelection.style.overflowY = '';
        }
    }, 0);
}


// Обновляем функцию populateExportCheckboxes
function populateExportCheckboxes() {
    const filteredCheatsheets = getFilteredCheatsheets();
    
    if (!exportCheckboxes) return;
    
    exportCheckboxes.innerHTML = '';
    
    if (filteredCheatsheets.length === 0) {
        exportCheckboxes.innerHTML = '<div class="export-no-items">Нет шпаргалок для выбора</div>';
        return;
    }
    
    // Создаем контейнер для чекбоксов
    const checkboxesContainer = document.createElement('div');
    checkboxesContainer.className = 'export-checkboxes-list';
    
    // Добавляем каждый чекбокс
    filteredCheatsheets.forEach(cheatsheet => {
        const checkboxItem = document.createElement('div');
        checkboxItem.className = 'export-checkbox-item';
        
        const isSelected = selectedCheatsheets.has(cheatsheet.id);
        if (isSelected) {
            checkboxItem.classList.add('selected');
        }
        
        const date = formatDateShort(cheatsheet.updatedAt || cheatsheet.createdAt);
        
        checkboxItem.innerHTML = `
            <input type="checkbox" id="export_${cheatsheet.id}" 
                   value="${cheatsheet.id}" ${isSelected ? 'checked' : ''}>
            <label for="export_${cheatsheet.id}" class="export-checkbox-content">
                <div class="export-checkbox-main">
                    <div class="export-checkbox-subject">${cheatsheet.subject}</div>
                    <div class="export-checkbox-title">${cheatsheet.title}</div>
                </div>
                <div class="export-checkbox-meta">
                    <span class="export-checkbox-task">${cheatsheet.taskNumber}</span>
                    <span class="export-checkbox-date">${date}</span>
                </div>
            </label>
        `;
        
        checkboxesContainer.appendChild(checkboxItem);
        
        // Обработчик клика на весь элемент
                // Обработчик клика на весь элемент
        checkboxItem.addEventListener('click', (e) => {
            const checkbox = checkboxItem.querySelector('input[type="checkbox"]');
            const label = checkboxItem.querySelector('label');
            
            // Проверяем, на какой элемент был клик
            const clickedElement = e.target;
            
            // Если кликнули на сам чекбокс
            if (clickedElement === checkbox) {
                // Ничего не делаем - событие change сработает автоматически
                return;
            }
            
            // Если кликнули на label или его дочерние элементы
            if (clickedElement === label || label.contains(clickedElement)) {
                // Клик на label автоматически изменит состояние связанного чекбокса
                // благодаря атрибуту for, поэтому ничего не делаем
                return;
            }
            
            // Если кликнули на сам элемент checkboxItem (но не на чекбокс и не на label)
            // Тогда переключаем чекбокс вручную
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
        });
        
        // Обработчик изменения чекбокса
        const checkbox = checkboxItem.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', (e) => {
            e.stopPropagation();
            if (checkbox.checked) {
                selectedCheatsheets.add(cheatsheet.id);
            
            } else {
                selectedCheatsheets.delete(cheatsheet.id);
            
            }
            updateExportCheckboxes();
            exportSelectedCount.textContent = selectedCheatsheets.size;
        });
    });
    
    // Создаем контейнер для кнопок
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'export-checkbox-actions';
    
    // Определяем, все ли отфильтрованные выбраны
    const allFilteredSelected = filteredCheatsheets.length > 0 && 
        filteredCheatsheets.every(c => selectedCheatsheets.has(c.id));
    
    actionsDiv.innerHTML = `
        <button type="button" class="btn-text" id="selectAllBtn">
            <i class="fas ${allFilteredSelected ? 'fa-square' : 'fa-check-square'}"></i> 
            ${allFilteredSelected ? 'Снять выделение' : 'Выбрать все'}
        </button>
        <button type="button" class="btn-text" id="selectFilteredBtn">
            <i class="fas fa-filter"></i> Только отфильтрованные
        </button>
    `;
    
    exportCheckboxes.appendChild(actionsDiv);
    exportCheckboxes.appendChild(checkboxesContainer);
    
    // Обработчики для кнопок
    document.getElementById('selectAllBtn').addEventListener('click', () => {
        const allCurrentlySelected = filteredCheatsheets.every(c => 
            selectedCheatsheets.has(c.id)
        );
        
        if (allCurrentlySelected) {
            // Снимаем выделение со всех отфильтрованных
            filteredCheatsheets.forEach(cheatsheet => {
                selectedCheatsheets.delete(cheatsheet.id);
            });
        } else {
            // Выбираем все отфильтрованные
            filteredCheatsheets.forEach(cheatsheet => {
                selectedCheatsheets.add(cheatsheet.id);
            });
        }
        updateExportCheckboxes();
        exportSelectedCount.textContent = selectedCheatsheets.size;
    });
    
    document.getElementById('selectFilteredBtn').addEventListener('click', () => {
        // Очищаем предыдущий выбор
        selectedCheatsheets.clear();
        // Выбираем только отфильтрованные
        filteredCheatsheets.forEach(cheatsheet => {
            selectedCheatsheets.add(cheatsheet.id);
        });
        updateExportCheckboxes();
        exportSelectedCount.textContent = selectedCheatsheets.size;
    });
}
function updateExportCheckboxes() {
    const checkboxes = exportCheckboxes.querySelectorAll('input[type="checkbox"]');
    const filteredCheatsheets = getFilteredCheatsheets();
    const allSelected = filteredCheatsheets.length > 0 && 
        filteredCheatsheets.every(c => selectedCheatsheets.has(c.id));
    
    // Обновляем кнопку "Выбрать все"
    const selectAllBtn = document.getElementById('selectAllBtn');
    if (selectAllBtn) {
        selectAllBtn.innerHTML = `
            <i class="fas ${allSelected ? 'fa-square' : 'fa-check-square'}"></i> 
            ${allSelected ? 'Снять выделение' : 'Выбрать все'}
        `;
    }
    
    // Обновляем состояние всех чекбоксов
    checkboxes.forEach(checkbox => {
        const cheatsheetId = checkbox.value;
        // Проверяем, находится ли шпаргалка в отфильтрованном списке
        const isInFiltered = filteredCheatsheets.some(c => c.id === cheatsheetId);
        
        if (isInFiltered) {
            // Обновляем состояние чекбокса в соответствии с selectedCheatsheets
            checkbox.checked = selectedCheatsheets.has(cheatsheetId);
        }
        
        const checkboxItem = checkbox.closest('.export-checkbox-item');
        if (checkboxItem) {
            if (checkbox.checked) {
                checkboxItem.classList.add('selected');
            } else {
                checkboxItem.classList.remove('selected');
            }
        }
    });
}
function confirmExport() {
    if (exportAllRadio && exportAllRadio.checked) {
        // Экспорт всех шпаргалок
        exportCheatsheets(cheatsheets);
    } else if (exportFilteredRadio && exportFilteredRadio.checked) {
        // Экспорт отфильтрованных шпаргалок
        const filteredCheatsheets = getFilteredCheatsheets();
        if (filteredCheatsheets.length === 0) {
            showToast('Нет отфильтрованных шпаргалок для экспорта', 'warning');
            return;
        }
        exportCheatsheets(filteredCheatsheets);
    } else if (exportSelectedRadio && exportSelectedRadio.checked) {
        // Экспорт выбранных шпаргалок
        const checkboxes = exportCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
        if (checkboxes.length === 0) {
            showToast('Выберите хотя бы одну шпаргалку для экспорта', 'warning');
            return;
        }
        
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        const selectedCheatsheetsToExport = cheatsheets.filter(c => selectedIds.includes(c.id));
        
        exportCheatsheets(selectedCheatsheetsToExport);
    }
    
    closeExportModal();
}

function getFilteredCheatsheets() {
    return cheatsheets.filter(cheatsheet => {
        if (currentFilter.subject !== 'all' && cheatsheet.subject !== currentFilter.subject) {
            return false;
        }
        
        if (currentFilter.task !== 'all' && cheatsheet.taskNumber !== parseInt(currentFilter.task)) {
            return false;
        }
        
        if (currentFilter.search) {
            const searchText = currentFilter.search;
            const inTitle = cheatsheet.title.toLowerCase().includes(searchText);
            const inContent = cheatsheet.content.toLowerCase().includes(searchText);
            const inSubject = cheatsheet.subject.toLowerCase().includes(searchText);
            
            if (!inTitle && !inContent && !inSubject) {
                return false;
            }
        }
        
        return true;
    });
}
function updateExportSelection() {
    if (exportSelectedRadio && exportSelectedRadio.checked) {
        exportSelection.style.display = 'block';
        // Убираем фиксированную высоту и прокрутку у блока выбора
        exportSelection.style.maxHeight = 'none';
        exportSelection.style.overflowY = 'visible';
        
        // Добавляем прокрутку основному контенту модального окна
        const modalBody = exportModal.querySelector('.modal-body');
        if (modalBody) {
            modalBody.style.overflowY = 'auto';
            modalBody.style.maxHeight = 'calc(90vh)';
        }
    } else {
        exportSelection.style.display = 'none';
        // Восстанавливаем стили для других режимов
        exportSelection.style.maxHeight = '';
        exportSelection.style.overflowY = '';
        
        const modalBody = exportModal.querySelector('.modal-body');
        if (modalBody) {
            modalBody.style.overflowY = '';
            modalBody.style.maxHeight = '';
        }
    }
}
// ===== МОБИЛЬНАЯ АДАПТИВНОСТЬ =====

// Проверяем мобильное устройство
function isMobileDevice() {
    return window.innerWidth <= 768 || 
           /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}
function updateCheatsheetListHeight() {
    if (!isMobileDevice()) return;
    
    const sidebar = document.querySelector('.sidebar');
    const header = document.querySelector('.sidebar-header');
    const btnNew = document.querySelector('.btn-new');
    const filters = document.querySelector('.filters');
    const footer = document.querySelector('.mobile-menu');
    const cheatsheetList = document.querySelector('.cheatsheet-list');
    
    if (sidebar && header && btnNew && filters && footer && cheatsheetList) {
        // Вычисляем использованную высоту
        const usedHeight = 
            header.offsetHeight + 
            btnNew.offsetHeight + 
            filters.offsetHeight + 
            footer.offsetHeight + 40; // 40px для отступов
        
        // Доступная высота
        const availableHeight = window.innerHeight - usedHeight;
        
        // Устанавливаем высоту списка
        cheatsheetList.style.maxHeight = `${Math.max(availableHeight, 100)}px`;
        cheatsheetList.style.height = `${Math.max(availableHeight, 100)}px`;
        
        // Принудительно обновляем прокрутку
        cheatsheetList.style.overflowY = 'auto';
    }
}
window.addEventListener('resize', function() {
    // Пересчитываем высоту списка
    setTimeout(updateCheatsheetListHeight, 100);
    
    // Обновляем отображение кнопок в зависимости от устройства
    const mobileMenu = document.querySelector('.mobile-menu');
    const sidebarFooter = document.querySelector('.sidebar-footer');
    
    if (mobileMenu && sidebarFooter) {
        if (isMobileDevice()) {
            mobileMenu.style.display = 'flex';
            sidebarFooter.style.display = 'none';
        } else {
            mobileMenu.style.display = 'none';
            sidebarFooter.style.display = 'flex';
        }
    }
});
// Обновляем функцию viewCheatsheet для мобильных
function mobileViewCheatsheet(cheatsheet) {
    if (!isMobileDevice()) return false;
    
    // Показываем main-content как модальное окно
    const mainContent = document.querySelector('.main-content');
    mainContent.classList.add('mobile-active');
    
    // Меняем кнопку "Назад"
    const closeBtn = document.getElementById('closeViewBtn');
    closeBtn.classList.add('mobile-back-btn');
    
    // Показываем шпаргалку обычным способом
    viewCheatsheet(cheatsheet);
    
    // Прокручиваем к началу
    mainContent.scrollTo(0, 0);
    
    // Блокируем прокрутку body
    document.body.style.overflow = 'hidden';
    
    return true;
}

// Обновляем функцию showListView для мобильных
function mobileShowListView() {
    if (!isMobileDevice()) return false;
    
    // Скрываем main-content
    const mainContent = document.querySelector('.main-content');
    mainContent.classList.remove('mobile-active');
    
    // Возвращаем обычную кнопку
    const closeBtn = document.getElementById('closeViewBtn');
    closeBtn.classList.remove('mobile-back-btn');
    
    // Разблокируем прокрутку
    document.body.style.overflow = '';
    
    // Сбрасываем активные элементы
    document.querySelectorAll('.cheatsheet-item.active, .grid-item.active').forEach(el => {
        el.classList.remove('active');
    });
    
    return true;
}

// Обновляем обработчики кликов на шпаргалки
function setupMobileView() {
    // Делегирование событий для списка
    const cheatsheetList = document.getElementById('cheatsheetList');
    if (cheatsheetList) {
        cheatsheetList.addEventListener('click', function(e) {
            const cheatsheetItem = e.target.closest('.cheatsheet-item');
            if (!cheatsheetItem) return;
            
            const cheatsheetId = cheatsheetItem.dataset.id;
            const cheatsheet = cheatsheets.find(c => c.id === cheatsheetId);
            
            if (cheatsheet && isMobileDevice()) {
                e.preventDefault();
                e.stopPropagation();
                mobileViewCheatsheet(cheatsheet);
            }
        });
    }
    
    // Для сетки
    const cheatsheetGrid = document.getElementById('cheatsheetGrid');
    if (cheatsheetGrid) {
        cheatsheetGrid.addEventListener('click', function(e) {
            const gridItem = e.target.closest('.grid-item');
            if (!gridItem) return;
            
            const cheatsheetId = gridItem.dataset.id;
            const cheatsheet = cheatsheets.find(c => c.id === cheatsheetId);
            
            if (cheatsheet && isMobileDevice()) {
                e.preventDefault();
                e.stopPropagation();
                mobileViewCheatsheet(cheatsheet);
            }
        });
    }
    
    // Обновляем кнопку "Назад" для мобильных
    const closeViewBtn = document.getElementById('closeViewBtn');
    if (closeViewBtn) {
        closeViewBtn.addEventListener('click', function() {
            if (isMobileDevice() && document.querySelector('.main-content').classList.contains('mobile-active')) {
                mobileShowListView();
            }
        });
    }
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isMobileDevice() && 
            document.querySelector('.main-content').classList.contains('mobile-active')) {
            mobileShowListView();
        }
    });
    
    // Адаптация при изменении размера окна
    window.addEventListener('resize', function() {
        if (!isMobileDevice() && document.querySelector('.main-content').classList.contains('mobile-active')) {
            mobileShowListView();
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    // ... существующий код ...
    
    // Настраиваем мобильный вид
    setupMobileView();
    
    // Инициализируем высоту списка после небольшой задержки
    setTimeout(function() {
        updateCheatsheetListHeight();
        
        // Наблюдаем за изменениями в DOM для обновления высоты
        const observer = new MutationObserver(function() {
            setTimeout(updateCheatsheetListHeight, 50);
        });
        
        const cheatsheetList = document.querySelector('.cheatsheet-list');
        if (cheatsheetList) {
            observer.observe(cheatsheetList, { 
                childList: true, 
                subtree: true 
            });
        }
    }, 300); // Увеличиваем задержку для полной загрузки DOM
    
    // Скрываем кнопку закрытия просмотра на десктопах
    if (!isMobileDevice()) {
        const closeViewBtn = document.getElementById('closeViewBtn');
        if (closeViewBtn) {
            closeViewBtn.style.display = 'none';
        }
    }
});
